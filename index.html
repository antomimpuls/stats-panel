  <script>
    // ===== НАСТРОЙКИ =====
    const API_KEY = 'AIzaSyDpZhPrGTvEnWfpe32sOWs37UlApmwcclI';
    const SPREADSHEET_ID = '10W4LpgK3NGElOv0O1nnTw92cyCeBMAtnFX0dDMOEAjU';
    const DATA_RANGE = 'data!A:E'; // Диапазон с основными данными
    const COMMENTS_RANGE = 'comments!A:B'; // Диапазон для комментариев (сайт, комментарий)
    // ВАЖНО: Обновите этот URL на тот, который вы получили после развертывания Apps Script
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQoTQPStRV0ZUr5s3EFAtvgC62jbVjH2cp8VLrMPKBi3vDkoAmafVb_fC4L-jw0LBZ/exec';

    // ===== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =====
    let rawData = []; // Данные из Google Sheets
    let comments = {}; // Комментарии из Google Sheets
    let isResizing = false;
    let currentColumn = null;
    let startX = 0;
    let startWidth = 0;

    // ===== ГЛАВНАЯ ФУНКЦИЯ ЗАГРУЗКИ =====
    async function loadStats() {
      try {
        document.body.classList.add('loading');
        showMessage('Загрузка данных...', 'warning'); // Показываем временное сообщение

        // Загружаем основные данные
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_RANGE}?key=${API_KEY}`;
        const dataRes = await fetch(dataUrl);
        const data = await dataRes.json();
        if (!data.values || data.values.length < 2){
          showError('В таблице нет данных');
          return;
        }
        rawData = data.values.slice(1);

        // Загружаем комментарии из Google Sheets
        const commentsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${COMMENTS_RANGE}?key=${API_KEY}`;
        const commentsRes = await fetch(commentsUrl);
        const commentsData = await commentsRes.json();
        comments = {}; // Сбрасываем локальный кэш
        if (commentsData.values && commentsData.values.length > 1) {
            // Начинаем с 1, чтобы пропустить заголовки
            commentsData.values.slice(1).forEach(([site, comment]) => {
                if (site) { // Проверяем, что сайт указан
                    comments[site] = comment || ''; // Сохраняем комментарий или пустую строку
                }
            });
        }

        renderTable();
        hideMessage(); // Скрываем сообщение после загрузки
      } catch (e){
        showError('Ошибка загрузки: '+ e.message);
        console.error('Ошибка загрузки:', e);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== РЕНДЕР ТАБЛИЦЫ С ФИЛЬТРОМ =====
    function renderTable(dateStr = new Date().toISOString().split('T')[0]) {
      const stats = {};
      let lastVisit = new Date(0);

      // Собираем все уникальные сайты
      const allSites = [...new Set(rawData.map(row => row[0]))];

      // Инициализируем статистику для всех сайтов
      allSites.forEach(site => {
        if (!stats[site]) {
          stats[site] = {
            visits: 0,
            clicks: 0,
            unique: 0,
            last: new Date(0),
            hasData: false
          };
        }
      });

      // Заполняем статистику данными
      rawData.forEach(([site, v, c, ts, dateOnly]) => {
        const rowDate = dateOnly || new Date(ts).toISOString().split('T')[0];
        if(dateStr && rowDate !== dateStr) return;

        const date = new Date(ts);
        if(date > lastVisit) lastVisit = date;

        if(stats[site]) {
          stats[site].visits += parseInt(v) || 0;
          stats[site].clicks += parseInt(c) || 0;
          stats[site].unique += (parseInt(v) || 0) > 0 ? 1 : 0;
          stats[site].hasData = true;

          if(date > stats[site].last) stats[site].last = date;
        }
      });

      const tbody = document.querySelector('#sitesTable tbody');
      tbody.innerHTML = '';

      Object.entries(stats)
        .sort(([,a],[,b])=>b.visits-a.visits)
        .forEach(([site,d])=>{
          const tr = document.createElement('tr');
          if (d.visits === 0 && d.clicks === 0) {
            tr.classList.add('zero-stats');
          }

          tr.innerHTML = `
            <td title="${site}">${site}</td>
            <td>${d.visits}</td>
            <td>${d.unique}</td>
            <td>${d.clicks}</td>
            <td>
              <input type="text" class="comment-input" value="${comments[site] || ''}"
                     placeholder="Комментарий" data-site="${site}">
            </td>
            <td>${d.last.getTime() > 0 ? d.last.toLocaleString() : 'Нет данных'}</td>
            <td>
              <button class="action-btn" onclick="resetSiteStats('${site}')">
                <i class="fas fa-eraser"></i> Сбросить
              </button>
              <!-- Кнопка удаления убрана, так как мы не хотим удалять из таблицы -->
            </td>`;
          tbody.appendChild(tr);

          // Добавляем обработчик события change для нового input
          const inputElement = tr.querySelector('.comment-input');
          inputElement.addEventListener('change', (e) => {
              saveComment(site, e.target.value);
          });
        });
    }

    // ===== ФУНКЦИИ ДЛЯ РАБОТЫ С КОММЕНТАРИЯМИ =====
    async function saveComment(site, comment) {
      try {
        // Обновляем локальную копию для немедленного отображения
        comments[site] = comment;

        // Отправляем данные на сервер для сохранения
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'saveComment',
            site: site,
            comment: comment,
            spreadsheetId: SPREADSHEET_ID
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Ошибка HTTP при сохранении комментария: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || result.message || 'Неизвестная ошибка при сохранении комментария');
        }

        console.log(`Комментарий для ${site} успешно сохранен на сервере.`);
        // Можно показать временное сообщение об успехе, если нужно
        // showMessage(`Комментарий для ${site} сохранен!`);

      } catch (error) {
        console.error('Ошибка при сохранении комментария:', error);
        alert('Ошибка при сохранении комментария: ' + error.message);
        // В случае ошибки можно вернуть старое значение в input или оставить как есть
      }
    }

    // ===== ФУНКЦИИ СБРОСА СТАТИСТИКИ (ТОЛЬКО В ПАНЕЛИ) =====
    function resetSiteStats(site) {
      if(!confirm(`Вы уверены, что хотите сбросить статистику для сайта ${site} ТОЛЬКО в этой панели? Данные в таблице останутся неизменными.`)) return;

      try {
        document.body.classList.add('loading');

        // Обновляем локальные данные rawData, обнуляя статистику для конкретного сайта
        rawData = rawData.map(row => {
          if (row[0] === site) {
            // Сохраняем сайт, дату, но обнуляем визиты и клики
            // Предполагаем, что формат row: [site, visits, clicks, timestamp, dateOnly]
            return [site, '0', '0', row[3] || new Date().toISOString(), row[4] || new Date().toISOString().split('T')[0]];
          }
          return row;
        });

        renderTable(); // Перерисовываем таблицу с обновленными данными
        showMessage(`Статистика для сайта ${site} сброшена в панели!`);

      } catch (error) {
        console.error('Ошибка при сбросе статистики в панели:', error);
        alert('Ошибка при сбросе статистики в панели: ' + error.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    function resetAllStats() {
      if(!confirm('Вы уверены, что хотите сбросить ВСЮ статистику ТОЛЬКО в этой панели? Данные в таблице останутся неизменными.')) return;

      try {
        document.body.classList.add('loading');

        // Обновляем локальные данные rawData, обнуляя статистику для всех сайтов
        rawData = rawData.map(row => {
          // Предполагаем, что формат row: [site, visits, clicks, timestamp, dateOnly]
          return [row[0], '0', '0', row[3] || new Date().toISOString(), row[4] || new Date().toISOString().split('T')[0]];
        });

        renderTable(); // Перерисовываем таблицу с обновленными данными
        showMessage('Вся статистика сброшена в панели!');

      } catch (error) {
        console.error('Ошибка при сбросе всей статистики в панели:', error);
        alert('Ошибка при сбросе всей статистики в панели: ' + error.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====
    function showMessage(message, type = 'success') {
      hideMessage(); // Удаляем предыдущее сообщение, если оно есть
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'success' ? 'success-message' : 'warning-message';
      messageDiv.textContent = message;
      messageDiv.id = 'tempMessage'; // Добавляем ID для удобства удаления
      document.querySelector('.container').insertBefore(messageDiv, document.getElementById('dateFilter'));

      if (type === 'success') {
          // Удаляем сообщение об успехе через 3 секунды
          setTimeout(() => {
              if (messageDiv.parentNode) { // Проверяем, существует ли элемент
                  messageDiv.remove();
              }
          }, 3000);
      }
      // Предупреждающие сообщения (например, о загрузке) удаляются вручную
    }

    function hideMessage() {
        const existingMessage = document.getElementById('tempMessage');
        if (existingMessage) {
            existingMessage.remove();
        }
    }


    function showError(msg){
      document.body.innerHTML = `<div class="error">${msg}</div>`;
    }

    // ===== ФУНКЦИИ ДЛЯ ИЗМЕНЕНИЯ РАЗМЕРА КОЛОНОК =====
    function initColumnResize() {
      const headers = document.querySelectorAll('th');

      headers.forEach(header => {
        header.addEventListener('mousedown', (e) => {
          if (e.offsetX > header.offsetWidth - 10) {
            isResizing = true;
            currentColumn = header;
            startX = e.pageX;
            startWidth = header.offsetWidth;

            document.body.style.cursor = 'col-resize';
            document.body.classList.add('resizing');

            e.preventDefault();
          }
        });
      });

      document.addEventListener('mousemove', (e) => {
        if (isResizing && currentColumn) {
          const newWidth = startWidth + (e.pageX - startX);
          if (newWidth > 50) { // Минимальная ширина колонки
            currentColumn.style.width = newWidth + 'px';

            // Обновляем ширину всех ячеек в этой колонке
            const columnIndex = Array.from(currentColumn.parentNode.children).indexOf(currentColumn);
            const rows = document.querySelectorAll('#sitesTable tr');

            rows.forEach(row => {
              const cell = row.children[columnIndex];
              if (cell) {
                cell.style.width = newWidth + 'px';
              }
            });
          }
        }
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          currentColumn = null;
          document.body.style.cursor = '';
          document.body.classList.remove('resizing');
        }
      });
    }

    // ===== УПРАВЛЕНИЕ ДАТОЙ =====
    const datePicker = document.getElementById('datePicker');
    datePicker.valueAsDate = new Date();
    datePicker.addEventListener('change',()=>renderTable(datePicker.value));

    document.querySelectorAll('.quickDate').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const offset = parseInt(btn.dataset.offset);
        const d = new Date();
        d.setDate(d.getDate()+offset);
        datePicker.valueAsDate = d;
        renderTable(d.toISOString().split('T')[0]);
      });
    });

    // ===== ОБРАБОТЧИКИ СОБЫТИЙ =====
    document.getElementById('refreshBtn').addEventListener('click', loadStats);
    document.getElementById('resetAllBtn').addEventListener('click', resetAllStats);

    // ===== ИНИЦИАЛИЗАЦИЯ =====
    loadStats();

    // Инициализируем изменение размера колонок после загрузки таблицы
    setTimeout(initColumnResize, 100);
  </script>
