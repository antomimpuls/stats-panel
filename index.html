<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0a0a0f;
      --card:#1a1a25;
      --accent:#b388eb;
      --text:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:20px;
      font-family:'Segoe UI',sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{max-width:1400px;margin:0 auto}
    .header-controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      flex-wrap:wrap;
      gap:15px;
    }
    .controls{
      display:flex;
      gap:12px;
    }
    .btn{
      background:var(--accent);
      border:0;
      border-radius:8px;
      padding:10px 20px;
      color:var(--bg);
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:.25s;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{opacity:.8}
    .btn.reset{background:#ff4757}
    
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      table-layout: fixed;
    }
    th, td{
      padding:12px;
      text-align:left;
      border-bottom:1px solid #333;
      position: relative;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th{
      background:#121218;
      color:var(--accent);
      cursor: col-resize;
      user-select: none;
    }
    th::after{
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 3px;
      height: 100%;
      background: var(--accent);
      opacity: 0.3;
      cursor: col-resize;
    }
    th:hover::after{
      opacity: 0.8;
    }
    tr:hover{background:#1f1f2a}
    
    .action-btn{
      background:var(--accent);
      border:0;
      border-radius:6px;
      padding:6px 12px;
      color:var(--bg);
      font-size:12px;
      cursor:pointer;
      transition:.25s;
    }
    .action-btn:hover{opacity:.8}
    
    .comment-input{
      background:var(--card);
      border:1px solid #333;
      border-radius:6px;
      padding:6px 10px;
      color:var(--text);
      font-size:14px;
      width: 100%;
      min-width: 150px;
      box-sizing: border-box;
    }
    .comment-input:focus{
      outline:none;
      border-color:var(--accent);
    }

    /* --- –§–∏–ª—å—Ç—Ä –¥–∞—Ç --- */
    #dateFilter{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:30px;
      margin-bottom:20px;
    }
    #dateFilter input[type=date]{
      background:var(--card);
      border:0;
      border-radius:8px;
      padding:8px 12px;
      color:var(--text);
      font-size:16px;
      cursor:pointer;
    }
    .quickDate{
      background:var(--accent);
      border:0;
      border-radius:8px;
      padding:8px 16px;
      color:var(--bg);
      font-size:14px;
      cursor:pointer;
      transition:.25s;
    }
    .quickDate:hover{opacity:.8}
    .error{color:#ff4757;text-align:center;padding:20px}
    
    .resizing {
      cursor: col-resize !important;
      user-select: none;
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .zero-stats {
      opacity: 0.6;
    }
    
    .success-message {
      background: #4CAF50;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-controls">
      <h1>üìä –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>
      <div class="controls">
        <button class="btn" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        </button>
        <button class="btn reset" id="resetAllBtn">
          <i class="fas fa-trash"></i> –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–µ–∑–¥–µ
        </button>
      </div>
    </div>

    <div id="dateFilter">
      <i class="fa-solid fa-calendar-days" style="font-size:1.3em;color:var(--accent)"></i>
      <input type="date" id="datePicker">
      <button class="quickDate" data-offset="-2">–ü–æ–∑–∞–≤—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="-1">–í—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="0">–°–µ–≥–æ–¥–Ω—è</button>
    </div>

    <table id="sitesTable">
      <thead>
        <tr>
          <th width="200">–°–∞–π—Ç</th>
          <th width="100">–í–∏–∑–∏—Ç—ã</th>
          <th width="120">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∏–∑–∏—Ç—ã</th>
          <th width="120">–ö–ª–∏–∫–∏ WhatsApp</th>
          <th width="250">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th width="150">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</th>
          <th width="120">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
    const API_KEY = 'AIzaSyDpZhPrGTvEnWfpe32sOWs37UlApmwcclI';
    const SPREADSHEET_ID = '10W4LpgK3NGElOv0O1nnTw92cyCeBMAtnFX0dDMOEAjU';
    const RANGE = 'data!A:E';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQoTQPStRV0ZUr5s3EFAtvgC62jbVjH2cp8VLrMPKBi3vDkoAmafVb_fC4L-jw0LBZ/exec';

    // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
    let rawData = [];
    let comments = JSON.parse(localStorage.getItem('siteComments') || '{}');
    let isResizing = false;
    let currentColumn = null;
    let startX = 0;
    let startWidth = 0;

    // ===== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø =====
    async function loadStats() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.values || data.values.length < 2){
          showError('–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
          return;
        }
        rawData = data.values.slice(1);
        renderTable();
      } catch (e){ 
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+ e.message);
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
      }
    }

    // ===== –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶–´ –° –§–ò–õ–¨–¢–†–û–ú =====
    function renderTable(dateStr = new Date().toISOString().split('T')[0]) {
      const stats = {};
      let lastVisit = new Date(0);

      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã
      const allSites = [...new Set(rawData.map(row => row[0]))];

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö —Å–∞–π—Ç–æ–≤
      allSites.forEach(site => {
        if (!stats[site]) {
          stats[site] = {
            visits: 0, 
            clicks: 0, 
            unique: 0,
            last: new Date(0),
            hasData: false
          };
        }
      });

      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–∞–Ω–Ω—ã–º–∏
      rawData.forEach(([site, v, c, ts, dateOnly]) => {
        const rowDate = dateOnly || new Date(ts).toISOString().split('T')[0];
        if(dateStr && rowDate !== dateStr) return;

        const date = new Date(ts);
        if(date > lastVisit) lastVisit = date;

        if(stats[site]) {
          stats[site].visits += parseInt(v) || 0;
          stats[site].clicks += parseInt(c) || 0;
          stats[site].unique += (parseInt(v) || 0) > 0 ? 1 : 0;
          stats[site].hasData = true;
          
          if(date > stats[site].last) stats[site].last = date;
        }
      });

      const tbody = document.querySelector('#sitesTable tbody');
      tbody.innerHTML = '';
      
      Object.entries(stats)
        .sort(([,a],[,b])=>b.visits-a.visits)
        .forEach(([site,d])=>{
          const tr = document.createElement('tr');
          if (d.visits === 0 && d.clicks === 0) {
            tr.classList.add('zero-stats');
          }
          
          tr.innerHTML = `
            <td title="${site}">${site}</td>
            <td>${d.visits}</td>
            <td>${d.unique}</td>
            <td>${d.clicks}</td>
            <td>
              <input type="text" class="comment-input" value="${comments[site] || ''}" 
                     placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" data-site="${site}"
                     onchange="saveComment('${site}', this.value)">
            </td>
            <td>${d.last.getTime() > 0 ? d.last.toLocaleString() : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td>
            <td>
              <button class="action-btn" onclick="resetSiteStats('${site}')">
                <i class="fas fa-eraser"></i> –°–±—Ä–æ—Å–∏—Ç—å
              </button>
              <button class="action-btn" style="background: #ff4757; margin-left: 5px;" onclick="deleteSite('${site}')">
                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
              </button>
            </td>`;
          tbody.appendChild(tr);
        });
    }

    // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø–ú–ò =====
    function saveComment(site, comment) {
      comments[site] = comment;
      localStorage.setItem('siteComments', JSON.stringify(comments));
    }

    // ===== –§–£–ù–ö–¶–ò–ò –°–ë–†–û–°–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò =====
    async function resetSiteStats(site) {
      if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è —Å–∞–π—Ç–∞ ${site}? –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã, –Ω–æ —Å–∞–π—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ.`)) return;
      
      try {
        document.body.classList.add('loading');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Google Apps Script –¥–ª—è —Å–±—Ä–æ—Å–∞
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'resetSite',
            site: site,
            spreadsheetId: SPREADSHEET_ID
          })
        });
        
        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ HTTP: ' + response.status);
        }
        
        const result = await response.json();
        
        if (result.success) {
          showMessage(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è —Å–∞–π—Ç–∞ ${site} —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω–∞!`);
          // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          rawData = rawData.map(row => {
            if (row[0] === site) {
              return [site, '0', '0', new Date().toISOString(), new Date().toISOString().split('T')[0]];
            }
            return row;
          });
          renderTable();
        } else {
          throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    async function resetAllStats() {
      if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã, –Ω–æ —Å–∞–π—Ç—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ.')) return;
      
      try {
        document.body.classList.add('loading');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Google Apps Script –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'resetAll',
            spreadsheetId: SPREADSHEET_ID
          })
        });
        
        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ HTTP: ' + response.status);
        }
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('–í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω–∞!');
          // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          rawData = rawData.map(row => {
            return [row[0], '0', '0', new Date().toISOString(), new Date().toISOString().split('T')[0]];
          });
          renderTable();
        } else {
          throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –°–ê–ô–¢–ê =====
    async function deleteSite(site) {
      if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å —Å–∞–π—Ç ${site} –∏–∑ —Å–∏—Å—Ç–µ–º—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) return;
      
      try {
        document.body.classList.add('loading');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Google Apps Script –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'deleteSite',
            site: site,
            spreadsheetId: SPREADSHEET_ID
          })
        });
        
        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ HTTP: ' + response.status);
        }
        
        const result = await response.json();
        
        if (result.success) {
          showMessage(`–°–∞–π—Ç ${site} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!`);
          // –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–∞–π—Ç–∞
          delete comments[site];
          localStorage.setItem('siteComments', JSON.stringify(comments));
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          await loadStats();
        } else {
          throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–∞–π—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–∞–π—Ç–∞: ' + error.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    function showMessage(message) {
      // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      const messageDiv = document.createElement('div');
      messageDiv.className = 'success-message';
      messageDiv.textContent = message;
      document.querySelector('.container').insertBefore(messageDiv, document.getElementById('dateFilter'));
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }

    function showError(msg){
      document.body.innerHTML = `<div class="error">${msg}</div>`;
    }

    // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø –†–ê–ó–ú–ï–†–ê –ö–û–õ–û–ù–û–ö =====
    function initColumnResize() {
      const headers = document.querySelectorAll('th');
      
      headers.forEach(header => {
        header.addEventListener('mousedown', (e) => {
          if (e.offsetX > header.offsetWidth - 10) {
            isResizing = true;
            currentColumn = header;
            startX = e.pageX;
            startWidth = header.offsetWidth;
            
            document.body.style.cursor = 'col-resize';
            document.body.classList.add('resizing');
            
            e.preventDefault();
          }
        });
      });
      
      document.addEventListener('mousemove', (e) => {
        if (isResizing && currentColumn) {
          const newWidth = startWidth + (e.pageX - startX);
          if (newWidth > 50) { // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏
            currentColumn.style.width = newWidth + 'px';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –≤—Å–µ—Ö —è—á–µ–µ–∫ –≤ —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–µ
            const columnIndex = Array.from(currentColumn.parentNode.children).indexOf(currentColumn);
            const rows = document.querySelectorAll('#sitesTable tr');
            
            rows.forEach(row => {
              const cell = row.children[columnIndex];
              if (cell) {
                cell.style.width = newWidth + 'px';
              }
            });
          }
        }
      });
      
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          currentColumn = null;
          document.body.style.cursor = '';
          document.body.classList.remove('resizing');
        }
      });
    }

    // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–¢–û–ô =====
    const datePicker = document.getElementById('datePicker');
    datePicker.valueAsDate = new Date();
    datePicker.addEventListener('change',()=>renderTable(datePicker.value));

    document.querySelectorAll('.quickDate').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const offset = parseInt(btn.dataset.offset);
        const d = new Date();
        d.setDate(d.getDate()+offset);
        datePicker.valueAsDate = d;
        renderTable(d.toISOString().split('T')[0]);
      });
    });

    // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
    document.getElementById('refreshBtn').addEventListener('click', loadStats);
    document.getElementById('resetAllBtn').addEventListener('click', resetAllStats);

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    loadStats();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    setTimeout(initColumnResize, 100);
  </script>
</body>
</html>
