<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0a0a0f;
      --card:#1a1a25;
      --accent:#b388eb;
      --text:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:20px;
      font-family:'Segoe UI',sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{max-width:1400px;margin:0 auto}
    .header-controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      flex-wrap:wrap;
      gap:15px;
    }
    .controls{
      display:flex;
      gap:12px;
    }
    .btn{
      background:var(--accent);
      border:0;
      border-radius:8px;
      padding:10px 20px;
      color:var(--bg);
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:.25s;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{opacity:.8}
    .btn.reset{background:#ff4757}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      table-layout: fixed;
    }
    th, td{
      padding:12px;
      text-align:left;
      border-bottom:1px solid #333;
      position: relative;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th{
      background:#121218;
      color:var(--accent);
      cursor: col-resize;
      user-select: none;
    }
    th::after{
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 3px;
      height: 100%;
      background: var(--accent);
      opacity: 0.3;
      cursor: col-resize;
    }
    th:hover::after{
      opacity: 0.8;
    }
    tr:hover{background:#1f1f2a}
    .action-btn{
      background:var(--accent);
      border:0;
      border-radius:6px;
      padding:6px 12px;
      color:var(--bg);
      font-size:12px;
      cursor:pointer;
      transition:.25s;
    }
    .action-btn:hover{opacity:.8}
    .comment-input{
      background:var(--card);
      border:1px solid #333;
      border-radius:6px;
      padding:6px 10px;
      color:var(--text);
      font-size:14px;
      width: 100%;
      min-width: 150px;
      box-sizing: border-box;
    }
    .comment-input:focus{
      outline:none;
      border-color:var(--accent);
    }
    /* --- –§–∏–ª—å—Ç—Ä –¥–∞—Ç --- */
    #dateFilter{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:30px;
      margin-bottom:20px;
    }
    #dateFilter input[type=date]{
      background:var(--card);
      border:0;
      border-radius:8px;
      padding:8px 12px;
      color:var(--text);
      font-size:16px;
      cursor:pointer;
    }
    .quickDate{
      background:var(--accent);
      border:0;
      border-radius:8px;
      padding:8px 16px;
      color:var(--bg);
      font-size:14px;
      cursor:pointer;
      transition:.25s;
    }
    .quickDate:hover{opacity:.8}
    .error{color:#ff4757;text-align:center;padding:20px}
    .resizing {
      cursor: col-resize !important;
      user-select: none;
    }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .zero-stats {
      opacity: 0.6;
    }
    .success-message {
      background: #4CAF50;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
    .warning-message {
      background: #ff9800;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
    /* --- Drag and drop styles --- */
    .draggable {
        cursor: move; /* fallback if grab cursor is unsupported */
        cursor: grab;
        user-select: none;
    }
    .draggable:active {
        cursor: grabbing;
    }
    .drag-over {
        border-top: 2px solid var(--accent) !important;
        /* background-color: rgba(179, 136, 235, 0.1); */
    }
    .drag-over-after {
        border-bottom: 2px solid var(--accent) !important;
        /* background-color: rgba(179, 136, 235, 0.1); */
    }
    .dragging {
        opacity: 0.5;
        background-color: #1f1f2a;
    }
    .column-header.drag-over-left {
        border-left: 2px solid var(--accent) !important;
    }
    .column-header.drag-over-right {
        border-right: 2px solid var(--accent) !important;
    }
    .reorder-info {
        font-size: 0.8em;
        color: #888;
        margin-top: 5px;
        font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-controls">
      <h1>üìä –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>
      <div class="controls">
        <button class="btn" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        </button>
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ -->
        <button class="btn reset" id="resetAllSheetsBtn">
          <i class="fas fa-trash"></i> –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–µ–∑–¥–µ
        </button>
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ç–æ–ª—å–∫–æ –≤ –ø–∞–Ω–µ–ª–∏ –£–î–ê–õ–ï–ù–ê -->
        <button class="btn" id="resetOrderBtn">
          <i class="fas fa-undo"></i> –°–±—Ä–æ—Å–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
        </button>
      </div>
    </div>
    <div id="dateFilter">
      <i class="fa-solid fa-calendar-days" style="font-size:1.3em;color:var(--accent)"></i>
      <input type="date" id="datePicker">
      <button class="quickDate" data-offset="-2">–ü–æ–∑–∞–≤—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="-1">–í—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="0">–°–µ–≥–æ–¥–Ω—è</button>
    </div>
     <p class="reorder-info">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤. –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ.</p>
    <table id="sitesTable">
      <thead>
        <tr id="tableHeaderRow">
          <!-- Headers will be populated by JS -->
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Rows will be populated by JS -->
      </tbody>
    </table>
  </div>
  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
    const API_KEY = 'AIzaSyDpZhPrGTvEnWfpe32sOWs37UlApmwcclI';
    const SPREADSHEET_ID = '10W4LpgK3NGElOv0O1nnTw92cyCeBMAtnFX0dDMOEAjU';
    const DATA_RANGE = 'data!A:F'; // <--- –¢–µ–ø–µ—Ä—å –∫–æ–ª–æ–Ω–∫–∞ F - IP
    const COMMENTS_RANGE = 'comments!A:B'; // –î–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (—Å–∞–π—Ç, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç URL –Ω–∞ —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ù–û–í–û–ì–û Apps Script
    // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ /
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQoTQPStRV0ZUr5s3EFAtvgC62jbVjH2cp8VLrMPKBi3vDkoAmafVb_fC4L-jw0LBZ/exec'; // <-- –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô
    // ===== –ö–õ–Æ–ß–ò –î–õ–Ø LOCAL STORAGE =====
    const COLUMN_ORDER_KEY = 'statsPanelColumnOrder';
    const ROW_ORDER_KEY = 'statsPanelRowOrder'; // –ù–æ–≤—ã–π –∫–ª—é—á –¥–ª—è –ø–æ—Ä—è–¥–∫–∞ —Å—Ç—Ä–æ–∫
    // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
    let rawData = []; // –î–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
    let comments = {}; // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ Google Sheets
    let isResizing = false;
    let currentColumn = null;
    let startX = 0;
    let startWidth = 0;
    let tableData = []; // –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ
    let columnOrder = ['site', 'visits', 'unique', 'clicks', 'comment', 'lastVisit', 'actions']; // –ü–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    let originalColumnOrder = [...columnOrder]; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
    let rowOrder = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç—Ä–æ–∫ (—Å–∞–π—Ç–æ–≤)
    
    /* ---------- –ü–æ–ª—É—á–∏—Ç—å IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---------- */
    async function getIP() {
      try {
        const r = await fetch('https://api.ipify.org?format=json');
        const data = await r.json();
        return data.ip || 'unknown';
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è IP:', err);
        return 'unknown';
      }
    }

    // ===== –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–†–û–°–ê –£–ù–ò–ö–ê–õ–¨–ù–´–• –í–ò–ó–ò–¢–û–í =====
    async function fetchUnique(site, date) {
      const form = new URLSearchParams();
      form.append('action', 'getUniqueVisits');
      form.append('site', site);
      form.append('date', date);
      try {
        const response = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form
        });
        const data = await response.json();
        return data.status === 'success' ? data.uniqueVisits : 0;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–≤:', error);
        return 0;
      }
    }
    // ===== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò =====
    async function loadStats() {
      try {
        document.body.classList.add('loading');
        showMessage('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'warning'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏–∑ localStorage
        loadSavedOrder();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_RANGE}?key=${API_KEY}`;
        const dataRes = await fetch(dataUrl);
        const data = await dataRes.json();
        if (!data.values || data.values.length < 2){
          showError('–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
          return;
        }
        rawData = data.values.slice(1);
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ Google Sheets
        const commentsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${COMMENTS_RANGE}?key=${API_KEY}`;
        const commentsRes = await fetch(commentsUrl);
        const commentsData = await commentsRes.json();
        comments = {}; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
        if (commentsData.values && commentsData.values.length > 1) {
            // –ù–∞—á–∏–Ω–∞–µ–º —Å 1, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
            commentsData.values.slice(1).forEach(([site, comment]) => {
                if (site) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∞–π—Ç —É–∫–∞–∑–∞–Ω
                    comments[site] = comment || ''; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                }
            });
        }
        await processTableData(); // <--- async
        renderTable(); // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ —Å—Ç—Ä–æ–∫
        hideMessage(); // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
      } catch (e){
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+ e.message);
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
      } finally {
        document.body.classList.remove('loading');
      }
    }
    // ===== –§–£–ù–ö–¶–ò–ò –°–û–•–†–ê–ù–ï–ù–ò–Ø/–ó–ê–ì–†–£–ó–ö–ò –ü–û–†–Ø–î–ö–ê =====
    function saveColumnOrder() {
        try {
            localStorage.setItem(COLUMN_ORDER_KEY, JSON.stringify(columnOrder));
        } catch (e) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ localStorage", e);
        }
    }
    function saveRowOrder() {
        try {
            localStorage.setItem(ROW_ORDER_KEY, JSON.stringify(rowOrder));
        } catch (e) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ –≤ localStorage", e);
        }
    }
    function loadSavedOrder() {
        try {
            const savedColumnOrder = localStorage.getItem(COLUMN_ORDER_KEY);
            if (savedColumnOrder) {
                columnOrder = JSON.parse(savedColumnOrder);
            }
        } catch (e) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ –∏–∑ localStorage", e);
            columnOrder = [...originalColumnOrder]; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }
        try {
            const savedRowOrder = localStorage.getItem(ROW_ORDER_KEY);
            if (savedRowOrder) {
                rowOrder = JSON.parse(savedRowOrder);
            }
        } catch (e) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ –∏–∑ localStorage", e);
            rowOrder = []; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }
    }
    function resetOrder() {
        if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ –∏ —Å—Ç–æ–ª–±—Ü–æ–≤?')) return;
        columnOrder = [...originalColumnOrder];
        rowOrder = [];
        try {
            localStorage.removeItem(COLUMN_ORDER_KEY);
            localStorage.removeItem(ROW_ORDER_KEY);
        } catch (e) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏–∑ localStorage", e);
        }
        renderTable(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –ø–æ—Ä—è–¥–∫–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–±—Ä–æ—à–µ–Ω!');
    }
    // ===== –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø –¢–ê–ë–õ–ò–¶–´ =====
    async function processTableData(selectedDate = new Date().toISOString().split('T')[0]) { // <--- async
        const stats = {};
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã
        const allSites = [...new Set(rawData.map(row => row[0]))];
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö —Å–∞–π—Ç–æ–≤
        allSites.forEach(site => {
            if (!stats[site]) {
            stats[site] = {
                visits: 0,
                clicks: 0,
                unique: 0, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                last: new Date(0),
                hasData: false
            };
            }
        });
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–∞–Ω–Ω—ã–º–∏ (–≤–∏–∑–∏—Ç—ã, –∫–ª–∏–∫–∏, –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç)
        rawData.forEach(([site, v, c, ts, dateOnly]) => {
            const rowDate = dateOnly || new Date(ts).toISOString().split('T')[0];
            if(selectedDate && rowDate !== selectedDate) return;
            const date = new Date(ts);
            if(stats[site]) {
            stats[site].visits += parseInt(v) || 0;
            stats[site].clicks += parseInt(c) || 0;
            stats[site].hasData = true;
            if(date > stats[site].last) stats[site].last = date;
            }
        });
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º stats –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ tableData —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–≤
        const promises = Object.entries(stats).map(async ([site, d]) => ({
            site: site,
            visits: d.visits,
            // unique: d.unique, // <--- —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∞
            unique: await fetchUnique(site, selectedDate), // <--- –Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
            clicks: d.clicks,
            comment: comments[site] || '',
            lastVisit: d.last.getTime() > 0 ? d.last : new Date(0), // –•—Ä–∞–Ω–∏–º –∫–∞–∫ Date object
            hasData: d.hasData
        }));
        tableData = await Promise.all(promises); // <--- –î–æ–∂–∏–¥–∞–µ–º—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (rowOrder.length > 0) {
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º tableData –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å rowOrder
            // –°–∞–π—Ç—ã, –Ω–µ –≤–æ—à–µ–¥—à–∏–µ –≤ rowOrder, –±—É–¥—É—Ç –≤ –∫–æ–Ω—Ü–µ
            tableData.sort((a, b) => {
                const indexA = rowOrder.indexOf(a.site);
                const indexB = rowOrder.indexOf(b.site);
                // –ï—Å–ª–∏ –æ–±–∞ —Å–∞–π—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ A –≤ —Å–ø–∏—Å–∫–µ, –æ–Ω –∏–¥–µ—Ç –ø–µ—Ä–≤—ã–º
                if (indexA !== -1) {
                    return -1;
                }
                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ B –≤ —Å–ø–∏—Å–∫–µ, –æ–Ω –∏–¥–µ—Ç –ø–µ—Ä–≤—ã–º
                if (indexB !== -1) {
                    return 1;
                }
                // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –Ω–µ –≤ —Å–ø–∏—Å–∫–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ø–æ –≤–∏–∑–∏—Ç–∞–º)
                return 0; // –ò–ª–∏ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å b.visits - a.visits –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            });
        } else {
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ø–æ —É–±—ã–≤–∞–Ω–∏—é –≤–∏–∑–∏—Ç–æ–≤
            tableData.sort((a, b) => b.visits - a.visits);
        }
    }
    // ===== –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶–´ –° –§–ò–õ–¨–¢–†–û–ú –ò –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï–ú =====
    function renderTable() {
      renderTableHeader();
      renderTableBody();
      initDragAndDrop(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
    }
    function renderTableHeader() {
        const theadRow = document.getElementById('tableHeaderRow');
        theadRow.innerHTML = '';
        columnOrder.forEach((colId, index) => {
            const th = document.createElement('th');
            th.className = 'column-header draggable'; // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å draggable
            th.dataset.columnId = colId; // –î–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
            th.draggable = true; // –î–µ–ª–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
            switch(colId) {
                case 'site': th.textContent = '–°–∞–π—Ç'; th.style.width = '200px'; break;
                case 'visits': th.textContent = '–í–∏–∑–∏—Ç—ã'; th.style.width = '100px'; break;
                case 'unique': th.textContent = '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∏–∑–∏—Ç—ã'; th.style.width = '120px'; break;
                case 'clicks': th.textContent = '–ö–ª–∏–∫–∏ WhatsApp'; th.style.width = '120px'; break;
                case 'comment': th.textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'; th.style.width = '250px'; break;
                case 'lastVisit': th.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç'; th.style.width = '150px'; break;
                case 'actions': th.textContent = '–î–µ–π—Å—Ç–≤–∏—è'; th.style.width = '120px'; break;
                default: th.textContent = colId;
            }
            theadRow.appendChild(th);
        });
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ initDragAndDrop
    }
    function renderTableBody() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        // tableData —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ processTableData
        const sortedData = tableData;
        sortedData.forEach((item, rowIndex) => {
            const tr = document.createElement('tr');
            tr.className = 'draggable-row'; // –ö–ª–∞—Å—Å –¥–ª—è —Å—Ç—Ä–æ–∫
            tr.draggable = true; // –î–µ–ª–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–π
            tr.dataset.site = item.site; // –î–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏
            if (item.visits === 0 && item.clicks === 0) {
                tr.classList.add('zero-stats');
            }
            columnOrder.forEach(colId => {
                const td = document.createElement('td');
                switch(colId) {
                    case 'site':
                        td.title = item.site;
                        td.textContent = item.site;
                        break;
                    case 'visits':
                        td.textContent = item.visits;
                        break;
                    case 'unique':
                        td.textContent = item.unique;
                        break;
                    case 'clicks':
                        td.textContent = item.clicks;
                        break;
                    case 'comment':
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'comment-input';
                        input.value = item.comment;
                        input.placeholder = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
                        input.dataset.site = item.site;
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è change –¥–ª—è –Ω–æ–≤–æ–≥–æ input
                        input.addEventListener('change', (e) => {
                            saveComment(item.site, e.target.value);
                            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ tableData
                            const dataItem = tableData.find(d => d.site === item.site);
                            if (dataItem) {
                                dataItem.comment = e.target.value;
                            }
                        });
                        td.appendChild(input);
                        break;
                    case 'lastVisit':
                        td.textContent = item.lastVisit.getTime() > 0 ? item.lastVisit.toLocaleString() : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                        break;
                    case 'actions':
                        const button = document.createElement('button');
                        button.className = 'action-btn';
                        button.innerHTML = '<i class="fas fa-eraser"></i> –°–±—Ä–æ—Å–∏—Ç—å';
                        button.onclick = () => resetSiteStats(item.site);
                        td.appendChild(button);
                        break;
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ initDragAndDrop
    }
    // ===== –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø =====
    function initDragAndDrop() {
        // --- –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫ ---
        const rows = document.querySelectorAll('.draggable-row');
        let draggedRow = null;
        rows.forEach(row => {
            row.addEventListener('dragstart', (e) => {
                draggedRow = row;
                row.classList.add('dragging');
                // –î–ª—è Firefox
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', row.outerHTML); // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ
            });
            row.addEventListener('dragend', (e) => {
                row.classList.remove('dragging');
                // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã drag-over
                document.querySelectorAll('.drag-over, .drag-over-after').forEach(el => {
                    el.classList.remove('drag-over', 'drag-over-after');
                });
                draggedRow = null;
            });
            row.addEventListener('dragover', (e) => {
                e.preventDefault(); // –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è drop
                e.dataTransfer.dropEffect = 'move';
            });
            row.addEventListener('dragenter', (e) => {
                e.preventDefault();
                // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã
                document.querySelectorAll('.drag-over, .drag-over-after').forEach(el => {
                    el.classList.remove('drag-over', 'drag-over-after');
                });
                const bounding = row.getBoundingClientRect();
                const offset = bounding.y + (bounding.height / 2);
                if (e.clientY - offset > 0) {
                    row.classList.add('drag-over-after');
                } else {
                    row.classList.add('drag-over');
                }
            });
            row.addEventListener('dragleave', (e) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –∫—É—Ä—Å–æ—Ä –ø–æ–∫–∏–Ω—É–ª —ç–ª–µ–º–µ–Ω—Ç
                const rect = row.getBoundingClientRect();
                if (e.clientY <= rect.top || e.clientY >= rect.bottom || e.clientX <= rect.left || e.clientX >= rect.right) {
                    row.classList.remove('drag-over', 'drag-over-after');
                }
            });
            row.addEventListener('drop', (e) => {
                e.preventDefault();
                row.classList.remove('drag-over', 'drag-over-after');
                if (draggedRow !== row) {
                    const bounding = row.getBoundingClientRect();
                    const offset = bounding.y + (bounding.height / 2);
                    const tbody = document.getElementById('tableBody');
                    if (e.clientY - offset > 0) {
                        tbody.insertBefore(draggedRow, row.nextSibling);
                    } else {
                        tbody.insertBefore(draggedRow, row);
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ rowOrder –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    updateRowOrderFromDOM();
                    saveRowOrder(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤ localStorage
                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                }
            });
        });
        // --- –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤ ---
        const headers = document.querySelectorAll('.column-header');
        let draggedHeader = null;
        headers.forEach((header, index) => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
            if (!header.style.width) {
                header.style.width = header.offsetWidth + 'px';
            }
            header.addEventListener('dragstart', (e) => {
                draggedHeader = header;
                header.classList.add('dragging');
                // –î–ª—è Firefox
                e.dataTransfer.effectAllowed = 'move';
            });
            header.addEventListener('dragend', (e) => {
                header.classList.remove('dragging');
                document.querySelectorAll('.column-header.drag-over-left, .column-header.drag-over-right').forEach(el => {
                    el.classList.remove('drag-over-left', 'drag-over-right');
                });
                draggedHeader = null;
            });
            header.addEventListener('dragover', (e) => {
                e.preventDefault(); // –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è drop
                e.dataTransfer.dropEffect = 'move';
            });
            header.addEventListener('dragenter', (e) => {
                e.preventDefault();
                if (draggedHeader === header) return;
                document.querySelectorAll('.column-header.drag-over-left, .column-header.drag-over-right').forEach(el => {
                    el.classList.remove('drag-over-left', 'drag-over-right');
                });
                const bounding = header.getBoundingClientRect();
                const midpoint = bounding.x + (bounding.width / 2);
                if (e.clientX < midpoint) {
                    header.classList.add('drag-over-left');
                } else {
                    header.classList.add('drag-over-right');
                }
            });
            header.addEventListener('dragleave', (e) => {
                 // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –∫—É—Ä—Å–æ—Ä –ø–æ–∫–∏–Ω—É–ª —ç–ª–µ–º–µ–Ω—Ç
                const rect = header.getBoundingClientRect();
                if (e.clientY <= rect.top || e.clientY >= rect.bottom || e.clientX <= rect.left || e.clientX >= rect.right) {
                    header.classList.remove('drag-over-left', 'drag-over-right');
                }
            });
            header.addEventListener('drop', (e) => {
                e.preventDefault();
                header.classList.remove('drag-over-left', 'drag-over-right');
                if (draggedHeader && draggedHeader !== header) {
                    const bounding = header.getBoundingClientRect();
                    const midpoint = bounding.x + (bounding.width / 2);
                    const oldIndex = columnOrder.indexOf(draggedHeader.dataset.columnId);
                    const newIndex = columnOrder.indexOf(header.dataset.columnId);
                    if (oldIndex > -1 && newIndex > -1) {
                        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å—Ç–∞—Ä–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        const movedItem = columnOrder.splice(oldIndex, 1)[0];
                        // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
                        // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –≤–ø—Ä–∞–≤–æ, –∏–Ω–¥–µ–∫—Å —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è
                        const insertIndex = e.clientX < midpoint ? newIndex : newIndex + 1;
                        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª –¥–æ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        const finalIndex = oldIndex < insertIndex ? insertIndex - 1 : insertIndex;
                        columnOrder.splice(finalIndex, 0, movedItem);
                        renderTable(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –Ω–æ–≤—ã–º –ø–æ—Ä—è–¥–∫–æ–º
                        saveColumnOrder(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤ localStorage
                        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    }
                }
            });
             // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫
             header.addEventListener('mousedown', (e) => {
                if (e.offsetX > header.offsetWidth - 10) {
                    isResizing = true;
                    currentColumn = header;
                    startX = e.pageX;
                    startWidth = header.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    document.body.classList.add('resizing');
                    e.preventDefault();
                }
                });
        });
    }
    // ===== –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ü–û–†–Ø–î–ö–ê –°–¢–†–û–ö –ò–ó DOM =====
    function updateRowOrderFromDOM() {
        const tbody = document.getElementById('tableBody');
        const newOrder = [];
        tbody.querySelectorAll('.draggable-row').forEach(row => {
            const site = row.dataset.site;
            if (site) {
                newOrder.push(site);
            }
        });
        rowOrder = newOrder;
    }
    // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø –†–ê–ó–ú–ï–†–ê –ö–û–õ–û–ù–û–ö (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)=====
    document.addEventListener('mousemove', (e) => {
        if (isResizing && currentColumn) {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth > 50) { // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏
            currentColumn.style.width = newWidth + 'px';
            // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –≤—Å–µ—Ö —è—á–µ–µ–∫ –≤ —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–µ
            const columnIndex = Array.from(currentColumn.parentNode.children).indexOf(currentColumn);
            const rows = document.querySelectorAll('#sitesTable tr');
            rows.forEach(row => {
            const cell = row.children[columnIndex];
            if (cell) {
                cell.style.width = newWidth + 'px';
            }
            });
        }
        }
    });
    document.addEventListener('mouseup', () => {
        if (isResizing) {
        isResizing = false;
        currentColumn = null;
        document.body.style.cursor = '';
        document.body.classList.remove('resizing');
        }
    });
    // ===== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–ë–†–û–° –°–¢–ê–¢–ò–°–¢–ò–ö–ò –í –¢–ê–ë–õ–ò–¶–ï =====
    async function resetSiteStats(site) {
      if (!confirm(`–û–±–Ω—É–ª–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è —Å–∞–π—Ç–∞ ¬´${site}¬ª –≤ —Ç–∞–±–ª–∏—Ü–µ?`)) return;
      const form = new URLSearchParams();
      form.append('action', 'resetSiteStats');
      form.append('site', site);
      try {
        document.body.classList.add('loading');
        const res = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form
        });
        const txt = await res.text();
        const data = JSON.parse(txt);
        if (data.status !== 'success') throw new Error(data.message);
        showMessage(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è ${site} –æ–±–Ω—É–ª–µ–Ω–∞ (${data.message})`);
        loadStats(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–Ω–µ–ª–∏
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
        console.error(err);
      } finally {
        document.body.classList.remove('loading');
      }
    }
    // ===== –£–ü–†–û–©–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í =====
    async function saveComment(site, comment) {
      const form = new URLSearchParams();
      form.append('action', 'saveComment');
      form.append('site', site);
      form.append('comment', comment);
      try {
        const res = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form,
        });
        const txt = await res.text();
        const data = JSON.parse(txt);
        if (data.status !== 'success') throw new Error(data.message);
        console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        showMessage('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + err.message);
        console.error(err);
      }
    }
    // ===== –§–£–ù–ö–¶–ò–ò –°–ë–†–û–°–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–¢–û–õ–¨–ö–û –í –ü–ê–ù–ï–õ–ò) =====
    function resetAllStats() {
      if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–π –ø–∞–Ω–µ–ª–∏? –î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏.')) return;
      try {
        document.body.classList.add('loading');
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ rawData, –æ–±–Ω—É–ª—è—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö —Å–∞–π—Ç–æ–≤
        rawData = rawData.map(row => {
          // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç row: [site, visits, clicks, timestamp, dateOnly]
          return [row[0], '0', '0', row[3] || new Date().toISOString(), row[4] || new Date().toISOString().split('T')[0]];
        });
        processTableData(); // –ü–µ—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        renderTable(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ —Å—Ç—Ä–æ–∫
        showMessage('–í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞ –≤ –ø–∞–Ω–µ–ª–∏!');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏: ' + error.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }
    // ===== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–ë–†–û–° –í–°–ï–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò –í –¢–ê–ë–õ–ò–¶–ï =====
    async function resetAllStatsInSheets() {
      if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É? –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Google Sheets.')) return;
      try {
        document.body.classList.add('loading');
        showMessage('–°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ...', 'warning');
        const form = new URLSearchParams();
        form.append('action', 'resetAllStats');
        const res = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form,
        });
        const txt = await res.text();
        const data = JSON.parse(txt);
        if (data.status !== 'success') throw new Error(data.message);
        showMessage('–í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–±—Ä–æ—à–µ–Ω–∞!');
        loadStats(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–Ω–µ–ª–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ: ' + error.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }
    // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    function showMessage(message, type = 'success') {
      hideMessage(); // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'success' ? 'success-message' : 'warning-message';
      messageDiv.textContent = message;
      messageDiv.id = 'tempMessage'; // –î–æ–±–∞–≤–ª—è–µ–º ID –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–¥–∞–ª–µ–Ω–∏—è
      document.querySelector('.container').insertBefore(messageDiv, document.getElementById('dateFilter'));
      if (type === 'success') {
          // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => {
              if (messageDiv.parentNode) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç
                  messageDiv.remove();
              }
          }, 3000);
      }
      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ –∑–∞–≥—Ä—É–∑–∫–µ) —É–¥–∞–ª—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é
    }
    function hideMessage() {
        const existingMessage = document.getElementById('tempMessage');
        if (existingMessage) {
            existingMessage.remove();
        }
    }
    function showError(msg){
      document.body.innerHTML = `<div class="error">${msg}</div>`;
    }
    // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–¢–û–ô =====
    const datePicker = document.getElementById('datePicker');
    datePicker.valueAsDate = new Date();
    datePicker.addEventListener('change', async ()=>{
        await processTableData(datePicker.value);
        renderTable();
    });
    document.querySelectorAll('.quickDate').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const offset = parseInt(btn.dataset.offset);
        const d = new Date();
        d.setDate(d.getDate()+offset);
        datePicker.valueAsDate = d;
        await processTableData(d.toISOString().split('T')[0]);
        renderTable();
      });
    });
    // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
    document.getElementById('refreshBtn').addEventListener('click', async () => {
      await loadStats();
    });
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ
    document.getElementById('resetAllSheetsBtn').addEventListener('click', resetAllStatsInSheets);
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –£–î–ê–õ–ï–ù
    document.getElementById('resetOrderBtn').addEventListener('click', resetOrder);

    // ===== –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–∏–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞) =====
    async function handleSaveStats() {
      const site = window.location.hostname;
      // –í —Ä–µ–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–≥—É—Ç –±—Ä–∞—Ç—å—Å—è –ø–æ-–¥—Ä—É–≥–æ–º—É –∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –ø–æ–¥—Å—á–µ—Ç–µ.
      // –ó–¥–µ—Å—å –º—ã –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º 1 –≤–∏–∑–∏—Ç –∏ 0 –∫–ª–∏–∫–æ–≤.
      const visitors = 1; 
      const clicks = 0;
      const ip = await getIP(); // <-- –ü–æ–ª—É—á–∞–µ–º IP

      const form = new URLSearchParams();
      form.append('action', 'saveStats');
      form.append('site', site);
      form.append('visitors', visitors.toString());
      form.append('clicks_whatsapp', clicks.toString());
      form.append('ip', ip); // <-- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º IP –≤–º–µ—Å—Ç–æ UID

      try {
        const response = await fetch(APPS_SCRIPT_URL.trim(), { // <-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
          method: 'POST',
          body: form
        });
        const data = await response.json();
        if (data.status === 'success') {
          console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (1 –≤–∏–∑–∏—Ç) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
        } else {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data.message);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
      }
    }
    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    (async () => {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        await handleSaveStats();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        await loadStats();
    })();
  </script>
</body>
</html>
