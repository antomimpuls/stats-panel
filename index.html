<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0a0a0f;
      --card:#1a1a25;
      --accent:#b388eb;
      --text:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:20px;
      font-family:'Segoe UI',sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{max-width:1200px;margin:0 auto}
    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px;
      margin-bottom:30px;
    }
    .card{
      background:var(--card);
      padding:20px;
      border-radius:12px;
      text-align:center;
    }
    .card h3{margin:0 0 10px;color:var(--accent)}
    .card p{font-size:24px;margin:0;font-weight:bold}

    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #333}
    th{background:#121218;color:var(--accent)}
    tr:hover{background:#1f1f2a}

    /* --- –§–∏–ª—å—Ç—Ä –¥–∞—Ç --- */
    #dateFilter{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:30px;
    }
    #dateFilter input[type=date]{
      background:var(--card);
      border:0;
      border-radius:8px;
      padding:8px 12px;
      color:var(--text);
      font-size:16px;
      cursor:pointer;
    }
    .quickDate{
      background:var(--accent);
      border:0;
      border-radius:8px;
      padding:8px 16px;
      color:var(--bg);
      font-size:14px;
      cursor:pointer;
      transition:.25s;
    }
    .quickDate:hover{opacity:.8}
    .error{color:#ff4757;text-align:center;padding:20px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>

    <div class="stats">
      <div class="card"><h3>–í—Å–µ–≥–æ –≤–∏–∑–∏—Ç–æ–≤</h3><p id="totalVisits">‚Äî</p></div>
      <div class="card"><h3>–ö–ª–∏–∫–æ–≤ WhatsApp</h3><p id="totalClicks">‚Äî</p></div>
      <div class="card"><h3>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–æ–≤</h3><p id="uniqueSites">‚Äî</p></div>
      <div class="card"><h3>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h3><p id="lastUpdate">‚Äî</p></div>
    </div>

    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–∞–π—Ç–∞–º</h2>

    <div id="dateFilter">
      <i class="fa-solid fa-calendar-days" style="font-size:1.3em;color:var(--accent)"></i>
      <input type="date" id="datePicker">
      <button class="quickDate" data-offset="-2">–ü–æ–∑–∞–≤—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="-1">–í—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="0">–°–µ–≥–æ–¥–Ω—è</button>
    </div>

    <table id="sitesTable">
      <thead>
        <tr>
          <th>–°–∞–π—Ç</th>
          <th>–í–∏–∑–∏—Ç—ã</th>
          <th>–ö–ª–∏–∫–∏ WhatsApp</th>
          <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
    const API_KEY        = 'AIzaSyDpZhPrGTvEnWfpe32sOWs37UlApmwcclI';
    const SPREADSHEET_ID = '10W4LpgK3NGElOv0O1nnTw92cyCeBMAtnFX0dDMOEAjU';
    const RANGE          = 'data!A:E';

    // ===== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø =====
    let rawData = [];
    async function loadStats() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.values || data.values.length < 2){
          showError('–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
          return;
        }
        rawData = data.values.slice(1);
        renderTable();
      } catch (e){ showError('–û—à–∏–±–∫–∞: '+ e.message) }
    }

    // ===== –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶–´ –° –§–ò–õ–¨–¢–†–û–ú =====
    function renderTable(dateStr){
      const stats = {};
      let totalVisits = 0, totalClicks = 0, lastVisit = new Date(0);

      rawData.forEach(([site, v, c, ts, dateOnly]) => {
        const rowDate = dateOnly || new Date(ts).toISOString().split('T')[0];
        if(dateStr && rowDate !== dateStr) return;

        const date = new Date(ts);
        if(date > lastVisit) lastVisit = date;

        if(!stats[site]) stats[site] = {visits:0, clicks:0, last:new Date(0)};
        stats[site].visits += parseInt(v) || 0;
        stats[site].clicks += parseInt(c) || 0;
        if(date > stats[site].last) stats[site].last = date;
      });

      totalVisits = Object.values(stats).reduce((s,x)=>s+x.visits,0);
      totalClicks = Object.values(stats).reduce((s,x)=>s+x.clicks,0);

      ['totalVisits','totalClicks','uniqueSites','lastUpdate']
        .forEach(id=>document.getElementById(id).textContent =
          id==='uniqueSites' ? Object.keys(stats).length :
          id==='lastUpdate'  ? lastVisit.toLocaleString() :
          id==='totalVisits' ? totalVisits : totalClicks);

      const tbody = document.querySelector('#sitesTable tbody');
      tbody.innerHTML = '';
      Object.entries(stats)
        .sort(([,a],[,b])=>b.visits-a.visits)
        .forEach(([site,d])=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${site}</td>
            <td>${d.visits}</td>
            <td>${d.clicks}</td>
            <td>${d.last.toLocaleString()}</td>`;
          tbody.appendChild(tr);
        });
    }

    // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–¢–û–ô =====
    const datePicker = document.getElementById('datePicker');
    datePicker.valueAsDate = new Date();
    datePicker.addEventListener('change',()=>renderTable(datePicker.value));

    document.querySelectorAll('.quickDate').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const offset = parseInt(btn.dataset.offset);
        const d = new Date();
        d.setDate(d.getDate()+offset);
        datePicker.valueAsDate = d;
        renderTable(d.toISOString().split('T')[0]);
      });
    });

    function showError(msg){
      document.body.innerHTML = `<div class="error">${msg}</div>`;
    }

    loadStats();
  </script>
</body>
</html>
