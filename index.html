<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0a0a0f;
      --card:#1a1a25;
      --accent:#b388eb;
      --text:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:20px;
      font-family:'Segoe UI',sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{max-width:1400px;margin:0 auto}
    .header-controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      flex-wrap:wrap;
      gap:15px;
    }
    .controls{
      display:flex;
      gap:12px;
    }
    .btn{
      background:var(--accent);
      border:0;
      border-radius:8px;
      padding:10px 20px;
      color:var(--bg);
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      transition:.25s;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{opacity:.8}
    .btn.reset{background:#ff4757}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      table-layout: fixed;
    }
    th, td{
      padding:12px;
      text-align:left;
      border-bottom:1px solid #333;
      position: relative;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th{
      background:#121218;
      color:var(--accent);
      cursor: col-resize;
      user-select: none;
    }
    th::after{
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 3px;
      height: 100%;
      background: var(--accent);
      opacity: 0.3;
      cursor: col-resize;
    }
    th:hover::after{
      opacity: 0.8;
    }
    tr:hover{background:#1f1f2a}
    .action-btn{
      background:var(--accent);
      border:0;
      border-radius:6px;
      padding:6px 12px;
      color:var(--bg);
      font-size:12px;
      cursor:pointer;
      transition:.25s;
    }
    .action-btn:hover{opacity:.8}
    .comment-input{
      background:var(--card);
      border:1px solid #333;
      border-radius:6px;
      padding:6px 10px;
      color:var(--text);
      font-size:14px;
      width: 100%;
      min-width: 150px;
      box-sizing: border-box;
    }
    .comment-input:focus{
      outline:none;
      border-color:var(--accent);
    }
    /* --- –§–∏–ª—å—Ç—Ä –¥–∞—Ç --- */
    #dateFilter{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:30px;
      margin-bottom:20px;
    }
    #dateFilter input[type=date]{
      background:var(--card);
      border:0;
      border-radius:8px;
      padding:8px 12px;
      color:var(--text);
      font-size:16px;
      cursor:pointer;
    }
    .quickDate{
      background:var(--accent);
      border:0;
      border-radius:8px;
      padding:8px 16px;
      color:var(--bg);
      font-size:14px;
      cursor:pointer;
      transition:.25s;
    }
    .quickDate:hover{opacity:.8}
    .error{color:#ff4757;text-align:center;padding:20px}
    .resizing {
      cursor: col-resize !important;
      user-select: none;
    }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .zero-stats {
      opacity: 0.6;
    }
    .success-message {
      background: #4CAF50;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
    .warning-message {
      background: #ff9800;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
    /* --- Drag and Drop Styles --- */
    .draggable {
      cursor: move;
    }
    .dragging {
      opacity: 0.5;
      background-color: #333;
    }
    .drag-over {
      border-top: 2px solid var(--accent);
    }
    .drag-over-bottom {
      border-bottom: 2px solid var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-controls">
      <h1>üìä –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>
      <div class="controls">
        <button class="btn" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        </button>
        <button class="btn reset" id="resetAllBtn">
          <i class="fas fa-trash"></i> –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–µ–∑–¥–µ
        </button>
        <button class="btn" id="resetSiteOrderBtn"> <!-- –ù–û–í–û–ï -->
          <i class="fas fa-sort"></i> –°–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–∞–π—Ç–æ–≤
        </button>
      </div>
    </div>
    <div id="dateFilter">
      <i class="fa-solid fa-calendar-days" style="font-size:1.3em;color:var(--accent)"></i>
      <input type="date" id="datePicker">
      <button class="quickDate" data-offset="-2">–ü–æ–∑–∞–≤—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="-1">–í—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="0">–°–µ–≥–æ–¥–Ω—è</button>
    </div>
    <table id="sitesTable">
      <thead>
        <tr>
          <th width="200" data-column="site">–°–∞–π—Ç</th>
          <th width="100" data-column="visits">–í–∏–∑–∏—Ç—ã</th>
          <th width="120" data-column="unique">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∏–∑–∏—Ç—ã</th>
          <th width="120" data-column="clicks">–ö–ª–∏–∫–∏ WhatsApp</th>
          <th width="100" data-column="redirects">–†–µ–¥–∏—Ä–µ–∫—Ç—ã</th> <!-- –ù–û–í–û–ï -->
          <th width="250" data-column="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th width="150" data-column="last">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</th>
          <th width="120" data-column="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
    const API_KEY = 'AIzaSyDpZhPrGTvEnWfpe32sOWs37UlApmwcclI';
    const SPREADSHEET_ID = '10W4LpgK3NGElOv0O1nnTw92cyCeBMAtnFX0dDMOEAjU';
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –£–±—Ä–∞–Ω –ø—Ä–æ–±–µ–ª –≤ URL
    const DATA_RANGE = 'data!A:F'; // –î–∏–∞–ø–∞–∑–æ–Ω —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–¥–æ F)
    const COMMENTS_RANGE = 'comments!A:B'; // –î–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (—Å–∞–π—Ç, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç URL –Ω–∞ —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ù–û–í–û–ì–û Apps Script
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ /
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQoTQPStRV0ZUr5s3EFAtvgC62jbVjH2cp8VLrMPKBi3vDkoAmafVb_fC4L-jw0LBZ/exec';
    // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
    let rawData = []; // –î–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
    let comments = {}; // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ Google Sheets
    let isResizing = false;
    let currentColumn = null;
    let startX = 0;
    let startWidth = 0;

    // ===== Drag and Drop Variables =====
    let draggedElement = null;
    let draggedType = null; // 'column' or 'row'
    let columnOrder = ['site', 'visits', 'unique', 'clicks', 'redirects', 'comment', 'last', 'actions']; // –ù–û–í–û–ï
    let siteOrder = []; // –ù–û–í–û–ï

    // ===== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò =====
    async function loadStats() {
      try {
        document.body.classList.add('loading');
        showMessage('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'warning'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –î–æ–±–∞–≤–ª–µ–Ω timestamp –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_RANGE}?key=${API_KEY}&timestamp=${Date.now()}`;
        const dataRes = await fetch(dataUrl);
        const data = await dataRes.json();
        if (!data.values || data.values.length < 2){
          showError('–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
          return;
        }
        rawData = data.values.slice(1);
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ Google Sheets
        const commentsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${COMMENTS_RANGE}?key=${API_KEY}`;
        const commentsRes = await fetch(commentsUrl);
        const commentsData = await commentsRes.json();
        comments = {}; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
        if (commentsData.values && commentsData.values.length > 1) {
            // –ù–∞—á–∏–Ω–∞–µ–º —Å 1, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
            commentsData.values.slice(1).forEach(([site, comment]) => {
                if (site) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∞–π—Ç —É–∫–∞–∑–∞–Ω
                    comments[site] = comment || ''; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                }
            });
        }
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ –∏–∑ localStorage
        loadOrderFromStorage();
        renderTable();
        hideMessage(); // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
      } catch (e){ 
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+ e.message);
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== Drag and Drop: Load Order from Storage =====
    function loadOrderFromStorage() {
        try {
            const savedColumnOrder = localStorage.getItem('columnOrder');
            if (savedColumnOrder) {
                const parsed = JSON.parse(savedColumnOrder);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –æ–∂–∏–¥–∞–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
                if (Array.isArray(parsed) && parsed.length === columnOrder.length && parsed.every(col => columnOrder.includes(col))) {
                    columnOrder = parsed;
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—è–¥–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ –∏–∑ localStorage:', e);
        }

        try {
            const savedSiteOrder = localStorage.getItem('siteOrder');
            if (savedSiteOrder) {
                const parsed = JSON.parse(savedSiteOrder);
                if (Array.isArray(parsed)) {
                    siteOrder = parsed;
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—è–¥–∫–∞ —Å–∞–π—Ç–æ–≤ –∏–∑ localStorage:', e);
        }
    }

    // ===== Drag and Drop: Save Order to Storage =====
    function saveOrderToStorage() {
        try {
            localStorage.setItem('columnOrder', JSON.stringify(columnOrder));
            localStorage.setItem('siteOrder', JSON.stringify(siteOrder));
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –≤ localStorage:', e);
        }
    }

    // ===== –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶–´ –° –§–ò–õ–¨–¢–†–û–ú –ò –ü–ï–†–ï–°–¢–ê–ù–û–í–ö–û–ô =====
    function renderTable(dateStr = new Date().toISOString().split('T')[0]) {
      const stats = {};
      let lastVisit = new Date(0);
      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã
      const allSites = [...new Set(rawData.map(row => row[0]))];

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö —Å–∞–π—Ç–æ–≤
      allSites.forEach(site => {
        if (!stats[site]) {
          stats[site] = {
            visits: 0, 
            clicks: 0, 
            redirects: 0, // –ù–û–í–û–ï
            unique: 0,
            last: new Date(0),
            hasData: false
          };
        }
      });

      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–∞–Ω–Ω—ã–º–∏
      // –§–æ—Ä–º–∞—Ç row: [site, visits, clicks, timestamp, dateOnly, redirects]
      rawData.forEach(([site, v, c, ts, dateOnly, r]) => {
        const rowDate = dateOnly || (ts ? new Date(ts).toISOString().split('T')[0] : '');
        if(dateStr && rowDate !== dateStr) return;
        const date = ts ? new Date(ts) : new Date(0);
        if(date > lastVisit) lastVisit = date;
        if(stats[site]) {
          stats[site].visits += parseInt(v) || 0;
          stats[site].clicks += parseInt(c) || 0;
          stats[site].redirects += parseInt(r) || 0; // –ù–û–í–û–ï
          stats[site].unique += (parseInt(v) || 0) > 0 ? 1 : 0;
          stats[site].hasData = true;
          if(date > stats[site].last) stats[site].last = date;
        }
      });

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–∞–π—Ç–æ–≤
      let sortedSiteEntries = Object.entries(stats);
      if (siteOrder.length > 0) {
          // –°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏ —Å–∞–π—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Å–∞–π—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ siteOrder
          sortedSiteEntries.sort((a, b) => a[0].localeCompare(b[0]));
          // –ó–∞—Ç–µ–º —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É –≤ siteOrder
          sortedSiteEntries.sort((a, b) => {
              const indexA = siteOrder.indexOf(a[0]);
              const indexB = siteOrder.indexOf(b[0]);
              // –ï—Å–ª–∏ —Å–∞–π—Ç –µ—Å—Ç—å –≤ siteOrder, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∏–Ω–¥–µ–∫—Å, –∏–Ω–∞—á–µ —Å—Ç–∞–≤–∏–º –≤ –∫–æ–Ω–µ—Ü
              const finalIndexA = indexA === -1 ? Infinity : indexA;
              const finalIndexB = indexB === -1 ? Infinity : indexB;
              return finalIndexA - finalIndexB;
          });
      } else {
          // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–∏–∑–∏—Ç–∞–º
          sortedSiteEntries.sort(([,a],[,b])=>b.visits-a.visits);
      }

      const tbody = document.querySelector('#sitesTable tbody');
      tbody.innerHTML = '';

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫
      const theadRow = document.querySelector('#sitesTable thead tr');
      const headerCells = Array.from(theadRow.children);
      headerCells.forEach(cell => theadRow.removeChild(cell)); // –û—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
      columnOrder.forEach(colKey => {
          const th = document.querySelector(`th[data-column="${colKey}"]`);
          // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –í–∞–ª–∏–¥–∞—Ü–∏—è header
          if (th) {
              theadRow.appendChild(th);
          }
      });

      sortedSiteEntries.forEach(([site, d])=>{
        const tr = document.createElement('tr');
        tr.setAttribute('data-site', site); // –î–ª—è drag and drop
        tr.classList.add('draggable'); // –î–ª—è drag and drop
        tr.draggable = true; // –î–ª—è drag and drop
        if (d.visits === 0 && d.clicks === 0 && d.redirects === 0) { // –ù–û–í–û–ï
          tr.classList.add('zero-stats');
        }

        // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ columnOrder
        let cells = {};
        cells.site = `<td title="${site}">${site}</td>`;
        cells.visits = `<td>${d.visits}</td>`;
        cells.unique = `<td>${d.unique}</td>`;
        cells.clicks = `<td>${d.clicks}</td>`;
        cells.redirects = `<td>${d.redirects}</td>`; // –ù–û–í–û–ï
        cells.comment = `<td><input type="text" class="comment-input" value="${comments[site] || ''}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" data-site="${site}"></td>`;
        cells.last = `<td>${d.last.getTime() > 0 ? d.last.toLocaleString() : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td>`;
        cells.actions = `<td><button class="action-btn" onclick="resetSiteStats('${site}')"><i class="fas fa-eraser"></i> –°–±—Ä–æ—Å–∏—Ç—å</button></td>`;

        columnOrder.forEach(colKey => {
            if (cells[colKey] !== undefined) {
                tr.innerHTML += cells[colKey];
            }
        });

        tbody.appendChild(tr);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è change –¥–ª—è –Ω–æ–≤–æ–≥–æ input
        const inputElement = tr.querySelector('.comment-input');
        if (inputElement) {
            inputElement.addEventListener('change', (e) => {
                saveComment(site, e.target.value);
            });
        }
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag and drop –¥–ª—è —Å—Ç—Ä–æ–∫
      initRowDragAndDrop();
    }

    // ===== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–ë–†–û–° –°–¢–ê–¢–ò–°–¢–ò–ö–ò –í –¢–ê–ë–õ–ò–¶–ï =====
    // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function resetSiteStats(site) {
      if (!confirm(`–û–±–Ω—É–ª–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è —Å–∞–π—Ç–∞ ¬´${site}¬ª –≤ —Ç–∞–±–ª–∏—Ü–µ?`)) return;
      const form = new URLSearchParams();
      form.append('action', 'resetSiteStats');
      form.append('site', site);
      try {
        document.body.classList.add('loading');
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ü—Ä–∏–º–µ–Ω—ë–Ω .trim()
        const res = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form
          // –ù–ï —Å—Ç–∞–≤–∏–º headers ‚Äî –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –¥–æ–±–∞–≤–∏—Ç Content-Type: application/x-www-form-urlencoded
        });
        const txt = await res.text();
        const data = JSON.parse(txt);
        if (data.status !== 'success') throw new Error(data.message);
        showMessage(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è ${site} –æ–±–Ω—É–ª–µ–Ω–∞ (${data.message})`);
        loadStats(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–Ω–µ–ª–∏
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
        console.error(err);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== –£–ü–†–û–©–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í =====
    async function saveComment(site, comment) {
      const form = new URLSearchParams();
      form.append('action', 'saveComment');
      form.append('site', site);
      form.append('comment', comment);
      try {
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ü—Ä–∏–º–µ–Ω—ë–Ω .trim()
        const res = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form,
          // –ù–ï —Å—Ç–∞–≤–∏–º headers ‚Äî –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –¥–æ–±–∞–≤–∏—Ç Content-Type: application/x-www-form-urlencoded
        });
        const txt = await res.text();
        const data = JSON.parse(txt);
        if (data.status !== 'success') throw new Error(data.message);
        console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        showMessage('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + err.message);
        console.error(err);
      }
    }

    // ===== –§–£–ù–ö–¶–ò–ò –°–ë–†–û–°–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–¢–û–õ–¨–ö–û –í –ü–ê–ù–ï–õ–ò) =====
    function resetAllStats() {
      if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–π –ø–∞–Ω–µ–ª–∏? –î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏.')) return;
      try {
        document.body.classList.add('loading');
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ rawData, –æ–±–Ω—É–ª—è—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö —Å–∞–π—Ç–æ–≤
        // –§–æ—Ä–º–∞—Ç row: [site, visits, clicks, timestamp, dateOnly, redirects]
        rawData = rawData.map(row => {
          return [row[0], '0', '0', row[3] || new Date().toISOString(), row[4] || new Date().toISOString().split('T')[0], '0'];
        });
        renderTable(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        showMessage('–í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞ –≤ –ø–∞–Ω–µ–ª–∏!');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏: ' + error.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–ë–†–û–° –ü–û–†–Ø–î–ö–ê –°–ê–ô–¢–û–í =====
    function resetSiteOrder() {
        siteOrder = [];
        saveOrderToStorage();
        renderTable(datePicker.value);
        showMessage('–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–∞–π—Ç–æ–≤ —Å–±—Ä–æ—à–µ–Ω–∞.');
    }

    // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    function showMessage(message, type = 'success') {
      hideMessage(); // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'success' ? 'success-message' : 'warning-message';
      messageDiv.textContent = message;
      messageDiv.id = 'tempMessage'; // –î–æ–±–∞–≤–ª—è–µ–º ID –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–¥–∞–ª–µ–Ω–∏—è
      document.querySelector('.container').insertBefore(messageDiv, document.getElementById('dateFilter'));
      if (type === 'success') {
          // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => {
              if (messageDiv.parentNode) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç
                  messageDiv.remove();
              }
          }, 3000);
      }
      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ –∑–∞–≥—Ä—É–∑–∫–µ) —É–¥–∞–ª—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é
    }
    function hideMessage() {
        const existingMessage = document.getElementById('tempMessage');
        if (existingMessage) {
            existingMessage.remove();
        }
    }
    function showError(msg){
      document.body.innerHTML = `<div class="error">${msg}</div>`;
    }

    // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø –†–ê–ó–ú–ï–†–ê –ö–û–õ–û–ù–û–ö =====
    function initColumnResize() {
      const headers = document.querySelectorAll('th');
      headers.forEach(header => {
        header.addEventListener('mousedown', (e) => {
          if (e.offsetX > header.offsetWidth - 10) {
            isResizing = true;
            currentColumn = header;
            startX = e.pageX;
            startWidth = header.offsetWidth;
            document.body.style.cursor = 'col-resize';
            document.body.classList.add('resizing');
            e.preventDefault();
          }
        });
      });
      document.addEventListener('mousemove', (e) => {
        if (isResizing && currentColumn) {
          const newWidth = startWidth + (e.pageX - startX);
          if (newWidth > 50) { // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏
            currentColumn.style.width = newWidth + 'px';
            // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –≤—Å–µ—Ö —è—á–µ–µ–∫ –≤ —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–µ
            const columnIndex = Array.from(currentColumn.parentNode.children).indexOf(currentColumn);
            const rows = document.querySelectorAll('#sitesTable tr');
            rows.forEach(row => {
              const cell = row.children[columnIndex];
              if (cell) {
                cell.style.width = newWidth + 'px';
              }
            });
          }
        }
      });
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          currentColumn = null;
          document.body.style.cursor = '';
          document.body.classList.remove('resizing');
        }
      });
    }

    // ===== Drag and Drop: Column Headers =====
    function initColumnDragAndDrop() {
        const headers = document.querySelectorAll('#sitesTable thead th');

        headers.forEach(header => {
            header.setAttribute('draggable', 'true');
            header.classList.add('draggable');

            header.addEventListener('dragstart', (e) => {
                draggedElement = header;
                draggedType = 'column';
                header.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', header.dataset.column); // –ü–µ—Ä–µ–¥–∞–µ–º –∫–ª—é—á –∫–æ–ª–æ–Ω–∫–∏
            });

            header.addEventListener('dragend', () => {
                header.classList.remove('dragging');
                draggedElement = null;
                draggedType = null;
                document.querySelectorAll('#sitesTable th, #sitesTable td').forEach(cell => {
                    cell.classList.remove('drag-over');
                });
            });

            header.addEventListener('dragover', (e) => {
                if (draggedType !== 'column') return;
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const rect = header.getBoundingClientRect();
                const midX = rect.left + rect.width / 2;
                if (e.clientX < midX) {
                    header.classList.add('drag-over');
                    header.classList.remove('drag-over-bottom');
                } else {
                    header.classList.remove('drag-over');
                    header.classList.add('drag-over-bottom');
                }
            });

            header.addEventListener('dragleave', () => {
                header.classList.remove('drag-over', 'drag-over-bottom');
            });

            header.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedType !== 'column' || !draggedElement) return;

                const draggedColumnKey = e.dataTransfer.getData('text/plain');
                const targetColumnKey = header.dataset.column;

                if (draggedColumnKey === targetColumnKey) return;

                const draggedIndex = columnOrder.indexOf(draggedColumnKey);
                const targetIndex = columnOrder.indexOf(targetColumnKey);

                if (draggedIndex > -1 && targetIndex > -1) {
                    // –£–¥–∞–ª—è–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—É—é –∫–æ–ª–æ–Ω–∫—É
                    columnOrder.splice(draggedIndex, 1);
                    // –í—Å—Ç–∞–≤–ª—è–µ–º –µ—ë –ø–µ—Ä–µ–¥ —Ü–µ–ª–µ–≤–æ–π
                    const newTargetIndex = columnOrder.indexOf(targetColumnKey); // –ò–Ω–¥–µ–∫—Å –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
                    columnOrder.splice(newTargetIndex, 0, draggedColumnKey);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫
                    saveOrderToStorage();
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                    renderTable(datePicker.value);
                    // UX: –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                    showMessage('–ü–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
                }

                header.classList.remove('drag-over', 'drag-over-bottom');
            });
        });
    }

    // ===== Drag and Drop: Rows (Sites) =====
    function initRowDragAndDrop() {
        const rows = document.querySelectorAll('#sitesTable tbody tr');

        rows.forEach(row => {
            row.addEventListener('dragstart', (e) => {
                if (e.target !== row) return; // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º —Å–∞–º—É —Å—Ç—Ä–æ–∫—É, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
                draggedElement = row;
                draggedType = 'row';
                row.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', row.dataset.site); // –ü–µ—Ä–µ–¥–∞–µ–º –∏–º—è —Å–∞–π—Ç–∞
            });

            row.addEventListener('dragend', () => {
                row.classList.remove('dragging');
                draggedElement = null;
                draggedType = null;
                document.querySelectorAll('#sitesTable tbody tr').forEach(r => {
                    r.classList.remove('drag-over', 'drag-over-bottom');
                });
            });

            row.addEventListener('dragover', (e) => {
                if (draggedType !== 'row') return;
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const rect = row.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                if (e.clientY < midY) {
                    row.classList.add('drag-over');
                    row.classList.remove('drag-over-bottom');
                } else {
                    row.classList.remove('drag-over');
                    row.classList.add('drag-over-bottom');
                }
            });

            row.addEventListener('dragleave', () => {
                row.classList.remove('drag-over', 'drag-over-bottom');
            });

            row.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedType !== 'row' || !draggedElement) return;

                const draggedSite = e.dataTransfer.getData('text/plain');
                const targetSite = row.dataset.site;

                if (draggedSite === targetSite) return;

                // –û–±–Ω–æ–≤–ª—è–µ–º siteOrder
                let currentOrder = siteOrder.length > 0 ? [...siteOrder] : [...new Set(rawData.map(r => r[0]))];
                
                const draggedIndex = currentOrder.indexOf(draggedSite);
                const targetIndex = currentOrder.indexOf(targetSite);

                if (draggedIndex > -1 && targetIndex > -1) {
                    // –£–¥–∞–ª—è–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π —Å–∞–π—Ç
                    currentOrder.splice(draggedIndex, 1);
                    // –í—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –ø–µ—Ä–µ–¥ —Ü–µ–ª–µ–≤—ã–º
                    let newTargetIndex = currentOrder.indexOf(targetSite); // –ò–Ω–¥–µ–∫—Å –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ü—Ä–æ–≤–µ—Ä–∫–∞ newTargetIndex
                    if (newTargetIndex === -1) {
                        // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π —Å–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω), –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                        currentOrder.push(draggedSite);
                    } else {
                        currentOrder.splice(newTargetIndex, 0, draggedSite);
                    }

                    siteOrder = currentOrder;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫
                    saveOrderToStorage();
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                    renderTable(datePicker.value);
                    // UX: –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                    showMessage('–ü–æ—Ä—è–¥–æ–∫ —Å–∞–π—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
                }

                row.classList.remove('drag-over', 'drag-over-bottom');
            });
        });
    }


    // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–¢–û–ô =====
    const datePicker = document.getElementById('datePicker');
    datePicker.valueAsDate = new Date();
    datePicker.addEventListener('change',()=>renderTable(datePicker.value));
    document.querySelectorAll('.quickDate').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const offset = parseInt(btn.dataset.offset);
        const d = new Date();
        d.setDate(d.getDate()+offset);
        datePicker.valueAsDate = d;
        renderTable(d.toISOString().split('T')[0]);
      });
    });

    // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
    document.getElementById('refreshBtn').addEventListener('click', loadStats);
    document.getElementById('resetAllBtn').addEventListener('click', resetAllStats);
    // –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–∞–π—Ç–æ–≤
    document.getElementById('resetSiteOrderBtn').addEventListener('click', resetSiteOrder);

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    loadStats();
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫ –∏ drag and drop –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    setTimeout(() => {
        initColumnResize();
        initColumnDragAndDrop(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag and drop –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫
        // initRowDragAndDrop –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ renderTable
    }, 100);
  </script>
</body>
</html>
