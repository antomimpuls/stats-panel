/**
 * Обрабатывает POST-запросы для управления статистикой
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const spreadsheet = SpreadsheetApp.openById(data.spreadsheetId);
    const sheet = spreadsheet.getSheetByName('data') || spreadsheet.getActiveSheet();
    
    const range = sheet.getDataRange();
    const values = range.getValues();
    
    if (data.action === 'resetSite') {
      // Сброс статистики для конкретного сайта
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] === data.site) {
          sheet.getRange(i+1, 2).setValue(0); // Визиты
          sheet.getRange(i+1, 3).setValue(0); // Клики
          sheet.getRange(i+1, 4).setValue(new Date()); // Время
          sheet.getRange(i+1, 5).setValue(new Date().toISOString().split('T')[0]); // Дата
        }
      }
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        message: `Статистика для сайта ${data.site} сброшена`
      })).setMimeType(ContentService.MimeType.JSON);
    } 
    else if (data.action === 'resetAll') {
      // Сброс всей статистики
      for (let i = 1; i < values.length; i++) {
        sheet.getRange(i+1, 2).setValue(0);
        sheet.getRange(i+1, 3).setValue(0);
        sheet.getRange(i+1, 4).setValue(new Date());
        sheet.getRange(i+1, 5).setValue(new Date().toISOString().split('T')[0]);
      }
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        message: "Вся статистика сброшена"
      })).setMimeType(ContentService.MimeType.JSON);
    }
    else if (data.action === 'deleteSite') {
      // Удаление сайта полностью
      const rowsToDelete = [];
      for (let i = values.length - 1; i >= 1; i--) {
        if (values[i][0] === data.site) {
          rowsToDelete.push(i+1);
        }
      }
      rowsToDelete.forEach(row => sheet.deleteRow(row));
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        message: `Сайт ${data.site} удален`,
        deletedRows: rowsToDelete.length
      })).setMimeType(ContentService.MimeType.JSON);
    }
    else {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: "Неизвестное действие"
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Обрабатывает GET-запросы (для проверки работы)
 */
function doGet(e) {
  return ContentService.createTextOutput(
    JSON.stringify({
      status: "ready",
      message: "API для управления статистикой работает",
      available_actions: ["resetSite", "resetAll", "deleteSite"]
    })
  ).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Старая функция для добавления данных (оставляем для обратной совместимости)
 */
function addData(site, visitors, clicks) {
  const timestamp = new Date();
  const dateOnly = timestamp.toISOString().split('T')[0];
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.appendRow([site, visitors, clicks, timestamp, dateOnly]);
  
  return "Данные добавлены";
}
