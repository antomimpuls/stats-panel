<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#0a0a0f;--card:#1a1a25;--accent:#b388eb;--text:#fff;}
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);}
    .container{max-width:1400px;margin:0 auto}
    .header-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
    .controls{display:flex;gap:12px}
    .btn{background:var(--accent);border:0;border-radius:8px;padding:10px 20px;color:var(--bg);font-size:14px;font-weight:bold;cursor:pointer;transition:.25s;display:flex;align-items:center;gap:8px}
    .btn:hover{opacity:.8}
    .btn.reset{background:#ff4757}
    table{width:100%;border-collapse:collapse;margin-top:20px;table-layout:fixed}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #333;position:relative;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    th{background:#121218;color:var(--accent);cursor:col-resize;user-select:none}
    th::after{content:'';position:absolute;top:0;right:0;width:3px;height:100%;background:var(--accent);opacity:.3;cursor:col-resize}
    th:hover::after{opacity:.8}
    tr:hover{background:#1f1f2a}
    .action-btn{background:var(--accent);border:0;border-radius:6px;padding:6px 12px;color:var(--bg);font-size:12px;cursor:pointer;transition:.25s}
    .action-btn:hover{opacity:.8}
    .comment-input{background:var(--card);border:1px solid #333;border-radius:6px;padding:6px 10px;color:var(--text);font-size:14px;width:100%;min-width:150px;box-sizing:border-box}
    .comment-input:focus{outline:none;border-color:var(--accent)}
    .success-message{background:#4CAF50;color:white;padding:10px;border-radius:5px;margin:10px 0;text-align:center}
    .error{color:#ff4757;text-align:center;padding:20px}
    .loading{opacity:.7;pointer-events:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="header-controls">
      <h1>üìä –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>
      <div class="controls">
        <button class="btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <button class="btn reset" id="resetAllBtn"><i class="fas fa-trash"></i> –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–µ–∑–¥–µ</button>
      </div>
    </div>

    <div id="dateFilter">
      <i class="fa-solid fa-calendar-days" style="font-size:1.3em;color:var(--accent)"></i>
      <input type="date" id="datePicker">
      <button class="quickDate" data-offset="-2">–ü–æ–∑–∞–≤—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="-1">–í—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="0">–°–µ–≥–æ–¥–Ω—è</button>
    </div>

    <table id="sitesTable">
      <thead>
        <tr>
          <th width="200">–°–∞–π—Ç</th>
          <th width="100">–í–∏–∑–∏—Ç—ã</th>
          <th width="120">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∏–∑–∏—Ç—ã</th>
          <th width="120">–ö–ª–∏–∫–∏ WhatsApp</th>
          <th width="250">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th width="150">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</th>
          <th width="120">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API_KEY = 'AIzaSyDpZhPrGTvEnWfpe32sOWs37UlApmwcclI';
    const SPREADSHEET_ID = '10W4LpgK3NGElOv0O1nnTw92cyCeBMAtnFX0dDMOEAjU';
    const DATA_RANGE = 'data!A:E';
    const COMMENTS_RANGE = 'comments!A:B';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQoTQPStRV0ZUr5s3EFAtvgC62jbVjH2cp8VLrMPKBi3vDkoAmafVb_fC4L-jw0LBZ/exec';

    let rawData = [];
    let comments = {};

    async function loadStats() {
      try {
        document.body.classList.add('loading');
        const data = await (await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_RANGE}?key=${API_KEY}`)).json();
        const commentsData = await (await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${COMMENTS_RANGE}?key=${API_KEY}`)).json();
        rawData = data.values?.slice(1) || [];
        comments = {};
        if (commentsData.values?.length > 1) commentsData.values.slice(1).forEach(([s,c]) => comments[s]=c||'');
        renderTable();
      } catch(e){ alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message) } finally { document.body.classList.remove('loading'); }
    }

    function renderTable(dateStr=new Date().toISOString().split('T')[0]){
      const stats={};
      const allSites=[...new Set(rawData.map(r=>r[0]))];
      allSites.forEach(s=>stats[s]={visits:0,clicks:0,unique:0,last:new Date(0),hasData:false});
      rawData.forEach(([site,v,c,ts,dateOnly])=>{
        const rowDate=dateOnly||new Date(ts).toISOString().split('T')[0];
        if(dateStr&&rowDate!==dateStr)return;
        const d=new Date(ts);
        if(stats[site]){
          stats[site].visits+=parseInt(v)||0;
          stats[site].clicks+=parseInt(c)||0;
          stats[site].unique+=(parseInt(v)||0)>0?1:0;
          stats[site].hasData=true;
          if(d>stats[site].last)stats[site].last=d;
        }
      });
      const tbody=document.querySelector('#sitesTable tbody');
      tbody.innerHTML='';
      Object.entries(stats).sort(([,a],[,b])=>b.visits-a.visits).forEach(([site,d])=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td title="${site}">${site}</td>
          <td>${d.visits}</td>
          <td>${d.unique}</td>
          <td>${d.clicks}</td>
          <td><input class="comment-input" value="${comments[site]||''}" data-site="${site}"></td>
          <td>${d.last.getTime()>0?d.last.toLocaleString():'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td>
          <td>
            <button class="action-btn" onclick="deleteSiteStats('${site}')"><i class="fas fa-eraser"></i> –°–±—Ä–æ—Å–∏—Ç—å</button>
          </td>`;
        tbody.appendChild(tr);
        tr.querySelector('.comment-input').addEventListener('change',e=>saveComment(site,e.target.value));
      });
    }

    async function saveComment(site,comment){
      const form=new URLSearchParams();
      form.append('action','saveComment');
      form.append('site',site);
      form.append('comment',comment);
      await fetch(APPS_SCRIPT_URL,{method:'POST',body:form});
    }

    async function deleteSiteStats(site){
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∞–π—Ç–∞ ${site} –∑–∞ —Å–µ–≥–æ–¥–Ω—è?`))return;
      const form=new URLSearchParams();
      form.append('action','deleteSite');
      form.append('site',site);
      await fetch(APPS_SCRIPT_URL,{method:'POST',body:form});
      loadStats();
    }

    async function deleteAllStats(){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è?'))return;
      const form=new URLSearchParams();
      form.append('action','deleteAll');
      await fetch(APPS_SCRIPT_URL,{method:'POST',body:form});
      loadStats();
    }

    document.getElementById('refreshBtn').addEventListener('click',loadStats);
    document.getElementById('resetAllBtn').addEventListener('click',deleteAllStats);

    const datePicker=document.getElementById('datePicker');
    datePicker.valueAsDate=new Date();
    datePicker.addEventListener('change',()=>renderTable(datePicker.value));
    document.querySelectorAll('.quickDate').forEach(b=>b.addEventListener('click',()=>{
      const d=new Date();
      d.setDate(d.getDate()+parseInt(b.dataset.offset));
      datePicker.valueAsDate=d;
      renderTable(d.toISOString().split('T')[0]);
    }));

    loadStats();
  </script>
</body>
</html>
