<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --bg:#0a0a0f;
      --card:#1a1a25;
      --accent:#b388eb;
      --text:#fff;
      --danger:#ff4757;
      --success:#28a745;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1400px;margin:0 auto}
    .header-controls{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:20px}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:var(--accent);border:0;border-radius:8px;padding:10px 20px;color:var(--bg);font-size:14px;font-weight:bold;cursor:pointer;transition:.25s;display:flex;align-items:center;gap:8px}
    .btn:hover{opacity:.8}
    .btn.reset{background:var(--danger)}
    #dateFilter{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:15px}
    #dateFilter input[type=date]{background:var(--card);border:0;border-radius:8px;padding:8px 12px;color:var(--text);font-size:16px;cursor:pointer}
    .quickDate{background:var(--accent);border:0;border-radius:8px;padding:8px 16px;color:var(--bg);font-size:14px;cursor:pointer}
    .quickDate:hover{opacity:.8}
    .reorder-info{font-size:.8em;color:#888;margin-bottom:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #333;white-space:nowrap}
    th{background:#121218;color:var(--accent);cursor:col-resize;user-select:none;position:relative}
    th::after{content:'';position:absolute;top:0;right:0;width:3px;height:100%;background:var(--accent);opacity:.3}
    th:hover::after{opacity:.8}
    tr:hover{background:#1f1f2a}
    .action-btn{background:var(--accent);border:0;border-radius:50%;width:30px;height:30px;color:var(--bg);font-size:14px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;margin:2px}
    .action-btn:hover{opacity:.8}
    .comment-input{background:var(--card);border:1px solid #333;border-radius:6px;padding:6px 10px;color:var(--text);width:100%}
    .comment-input:focus{outline:none;border-color:var(--accent)}
    .loading{opacity:.7;pointer-events:none}
    .drag-over{border-top:2px solid var(--accent)!important}
    .dragging{opacity:.5;background:#1f1f2a}
    .success-message,.warning-message{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:5px;color:#fff;z-index:1000}
    .success-message{background:var(--success)}
    .warning-message{background:#ff9800}
  </style>
</head>
<body>
  <div class="container">
    <div class="header-controls">
      <h1>üìä –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>
      <div class="controls">
        <button class="btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn reset" id="resetAllSheetsBtn"><i class="fas fa-trash"></i> –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë –≤ —Ç–∞–±–ª–∏—Ü–µ</button>
      </div>
    </div>

    <!-- –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–∞–º -->
    <div id="dateFilter">
      <i class="fa-solid fa-calendar-days" style="font-size:1.3em;color:var(--accent)"></i>
      <input type="date" id="datePicker">
      <button class="quickDate" data-offset="-2">–ü–æ–∑–∞–≤—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="-1">–í—á–µ—Ä–∞</button>
      <button class="quickDate" data-offset="0">–°–µ–≥–æ–¥–Ω—è</button>
    </div>

    <p class="reorder-info">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞. –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.</p>

    <table id="sitesTable">
      <thead>
        <tr id="tableHeaderRow"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- ===== –°–∫—Ä–∏–ø—Ç—ã ===== -->
  <script>
    /* ========== –ù–ê–°–¢–†–û–ô–ö–ò ========== */
    const API_KEY = 'AIzaSyDpZhPrGTvEnWfpe32sOWs37UlApmwcclI';
    const SPREADSHEET_ID = '10W4LpgK3NGElOv0O1nnTw92cyCeBMAtnFX0dDMOEAjU';
    const DATA_RANGE = 'data!A:F';
    const COMMENTS_RANGE = 'comments!A:B';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQoTQPStRV0ZUr5s3EFAtvgC62jbVjH2cp8VLrMPKBi3vDkoAmafVb_fC4L-jw0LBZ/exec';

    /* ========== –ö–õ–Æ–ß–ò LOCALSTORAGE ========== */
    const COLUMN_ORDER_KEY = 'statsPanelColumnOrder_v2';
    const ROW_ORDER_KEY    = 'statsPanelRowOrder_v2';

    /* ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ========== */
    let rawData   = [];
    let comments  = {};
    let tableData = [];
    let columnOrder = ['site','visits','clicks','comment','actions'];
    let rowOrder    = [];

    /* ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ========== */
    window.addEventListener('DOMContentLoaded', init);
    function init(){
      document.getElementById('refreshBtn').addEventListener('click', loadStats);
      document.getElementById('resetAllSheetsBtn').addEventListener('click', resetAllStatsInSheets);
      document.getElementById('datePicker').addEventListener('change', dateChanged);
      document.querySelectorAll('.quickDate').forEach(btn=>{
        btn.addEventListener('click', ()=>setQuickDate(parseInt(btn.dataset.offset)));
      });
      loadSavedOrder();
      loadStats();
    }

    /* ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ========== */
    async function loadStats(){
      document.body.classList.add('loading');
      try{
        /* ---- –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ---- */
        const dataRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_RANGE}?key=${API_KEY}`);
        const data = await dataRes.json();
        if(!data.values || data.values.length<2){ showError('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
        rawData = data.values.slice(1);

        /* ---- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ---- */
        const comRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${COMMENTS_RANGE}?key=${API_KEY}`);
        const com = await comRes.json();
        comments={};
        if(com.values && com.values.length>1){
          com.values.slice(1).forEach(([site,comment])=>{ if(site) comments[site]=comment||''; });
        }

        await processTableData();
        renderTable();
      }catch(e){
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message);
      }finally{
        document.body.classList.remove('loading');
      }
    }

    /* ========== –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• ========== */
    async function processTableData(selectedDate = new Date().toISOString().split('T')[0]){
      const stats={};
      const sites=[...new Set(rawData.map(r=>r[0]))];
      sites.forEach(s=>stats[s]={visits:0,clicks:0,hasData:false});
      rawData.forEach(([site,v,c,,dateOnly])=>{
        if(selectedDate && dateOnly!==selectedDate) return;
        if(stats[site]){
          stats[site].visits += parseInt(v)||0;
          stats[site].clicks += parseInt(c)||0;
          stats[site].hasData = true;
        }
      });
      tableData = Object.entries(stats).map(([site,d])=>({
        site,
        visits:d.visits,
        clicks:d.clicks,
        comment:comments[site]||'',
        hasData:d.hasData
      }));
      /* –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ */
      if(rowOrder.length){
        tableData.sort((a,b)=>{
          const ia=rowOrder.indexOf(a.site);
          const ib=rowOrder.indexOf(b.site);
          if(ia!==-1 && ib!==-1) return ia-ib;
          if(ia!==-1) return -1;
          if(ib!==-1) return 1;
          return 0;
        });
      }
    }

    /* ========== –†–ï–ù–î–ï–†–ò–ù–ì ========== */
    function renderTable(){
      renderHeader();
      renderBody();
      initDragAndDrop();
    }
    function renderHeader(){
      const tr=document.getElementById('tableHeaderRow');
      tr.innerHTML='';
      columnOrder.forEach(col=>{
        const th=document.createElement('th');
        th.className='column-header'; th.draggable=true; th.dataset.columnId=col;
        switch(col){
          case 'site': th.textContent='–°–∞–π—Ç'; break;
          case 'visits': th.textContent='–í–∏–∑–∏—Ç—ã'; break;
          case 'clicks': th.textContent='–ö–ª–∏–∫–∏ WA'; break;
          case 'comment': th.textContent='–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'; break;
          case 'actions': th.textContent='–î–µ–π—Å—Ç–≤–∏—è'; break;
        }
        tr.appendChild(th);
      });
    }
    function renderBody(){
      const tbody=document.getElementById('tableBody');
      tbody.innerHTML='';
      tableData.forEach(item=>{
        const tr=document.createElement('tr');
        tr.draggable=true; tr.dataset.site=item.site;
        columnOrder.forEach(col=>{
          const td=document.createElement('td');
          switch(col){
            case 'site': td.textContent=item.site; break;
            case 'visits': td.textContent=item.visits; break;
            case 'clicks': td.textContent=item.clicks; break;
            case 'comment':
              const inp=document.createElement('input');
              inp.type='text'; inp.className='comment-input'; inp.value=item.comment;
              inp.addEventListener('change',e=>saveComment(item.site,e.target.value));
              td.appendChild(inp);
              break;
            case 'actions':
              const btnReset=document.createElement('button');
              btnReset.className='action-btn'; btnReset.title='–°–±—Ä–æ—Å–∏—Ç—å'; btnReset.innerHTML='üóë';
              btnReset.onclick=()=>resetSiteStats(item.site);
              const btnGear=document.createElement('button');
              btnGear.className='action-btn'; btnGear.title='–ù–∞—Å—Ç—Ä–æ–π–∫–∏'; btnGear.innerHTML='‚öôÔ∏è';
              btnGear.onclick=()=>openSettingsModal(item.site);
              td.append(btnReset,btnGear);
              break;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    /* ========== DRAG & DROP ========== */
    function initDragAndDrop(){
      /* ----- —Å—Ç—Ä–æ–∫–∏ ----- */
      const tbody=document.getElementById('tableBody');
      let draggedRow=null;
      tbody.querySelectorAll('tr').forEach(row=>{
        row.addEventListener('dragstart',e=>{ draggedRow=row; row.classList.add('dragging'); });
        row.addEventListener('dragend',e=>row.classList.remove('dragging'));
        row.addEventListener('dragover',e=>e.preventDefault());
        row.addEventListener('dragenter',e=>{ if(row!==draggedRow) row.classList.add('drag-over'); });
        row.addEventListener('dragleave',e=>row.classList.remove('drag-over'));
        row.addEventListener('drop',e=>{
          e.preventDefault();
          if(draggedRow && draggedRow!==row){
            const rect=row.getBoundingClientRect();
            const next=e.clientY-rect.top<rect.height/2?row:row.nextSibling;
            tbody.insertBefore(draggedRow,next);
            updateRowOrderFromDOM();
            saveRowOrder();
          }
          [...tbody.children].forEach(r=>r.classList.remove('drag-over'));
        });
      });

      /* ----- –∫–æ–ª–æ–Ω–∫–∏ ----- */
      const headers=document.querySelectorAll('.column-header');
      let draggedHeader=null;
      headers.forEach(th=>{
        th.addEventListener('dragstart',e=>{ draggedHeader=th; th.classList.add('dragging'); });
        th.addEventListener('dragend',e=>th.classList.remove('dragging'));
        th.addEventListener('dragover',e=>e.preventDefault());
        th.addEventListener('dragenter',e=>{
          if(th===draggedHeader) return;
          const rect=th.getBoundingClientRect();
          const side=e.clientX<rect.left+rect.width/2?'left':'right';
          th.classList.add('drag-over-'+side);
        });
        th.addEventListener('dragleave',e=>th.classList.remove('drag-over-left','drag-over-right'));
        th.addEventListener('drop',e=>{
          e.preventDefault();
          th.classList.remove('drag-over-left','drag-over-right');
          if(!draggedHeader || draggedHeader===th) return;
          const from=columnOrder.indexOf(draggedHeader.dataset.columnId);
          const to=columnOrder.indexOf(th.dataset.columnId);
          if(from===-1||to===-1) return;
          const rect=th.getBoundingClientRect();
          const insert=e.clientX<rect.left+rect.width/2?to:to+1;
          const final=from<insert?insert-1:insert;
          columnOrder.splice(from,1);
          columnOrder.splice(final,0,draggedHeader.dataset.columnId);
          renderTable(); saveColumnOrder();
        });
      });
    }

    /* ========== –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê –ü–û–†–Ø–î–ö–ê ========== */
    function loadSavedOrder(){
      try{
        const c=localStorage.getItem(COLUMN_ORDER_KEY);
        if(c) columnOrder=JSON.parse(c);
        const r=localStorage.getItem(ROW_ORDER_KEY);
        if(r) rowOrder=JSON.parse(r);
      }catch(e){console.error(e);}
    }
    function saveColumnOrder(){ localStorage.setItem(COLUMN_ORDER_KEY,JSON.stringify(columnOrder)); }
    function saveRowOrder(){ localStorage.setItem(ROW_ORDER_KEY,JSON.stringify(rowOrder)); }
    function updateRowOrderFromDOM(){
      rowOrder=[...document.getElementById('tableBody').children].map(r=>r.dataset.site);
    }

    /* ========== –°–ë–†–û–° –°–¢–ê–¢–ò–°–¢–ò–ö–ò ========== */
    async function resetSiteStats(site){
      if(!confirm(`–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è ¬´${site}¬ª –≤ —Ç–∞–±–ª–∏—Ü–µ?`)) return;
      document.body.classList.add('loading');
      const form=new URLSearchParams();
      form.append('action','resetSiteStats'); form.append('site',site);
      try{
        const res=await fetch(APPS_SCRIPT_URL,{method:'POST',body:form});
        const txt=await res.text(); const data=JSON.parse(txt);
        if(data.status!=='success') throw new Error(data.message);
        loadStats();
      }catch(e){alert(e.message)}finally{document.body.classList.remove('loading')}
    }
    async function resetAllStatsInSheets(){
      if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ?')) return;
      document.body.classList.add('loading');
      const form=new URLSearchParams(); form.append('action','resetAllStats');
      try{
        const res=await fetch(APPS_SCRIPT_URL,{method:'POST',body:form});
        const txt=await res.text(); const data=JSON.parse(txt);
        if(data.status!=='success') throw new Error(data.message);
        loadStats();
      }catch(e){alert(e.message)}finally{document.body.classList.remove('loading')}
    }

    /* ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø ========== */
    async function saveComment(site,comment){
      const form=new URLSearchParams();
      form.append('action','saveComment'); form.append('site',site); form.append('comment',comment);
      try{
        const res=await fetch(APPS_SCRIPT_URL,{method:'POST',body:form});
        const txt=await res.text(); const data=JSON.parse(txt);
        if(data.status!=='success') throw new Error(data.message);
      }catch(e){alert(e.message)}
    }

    /* ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–¢–û–ô ========== */
    function setQuickDate(offset){
      const d=new Date(); d.setDate(d.getDate()+offset);
      document.getElementById('datePicker').valueAsDate=d;
      dateChanged();
    }
    async function dateChanged(){
      await processTableData(document.getElementById('datePicker').value);
      renderTable();
    }

    /* ========== –£–¢–ò–õ–ò–¢–´ ========== */
    function showError(msg){ alert(msg); }
  </script>

  <!-- –º–æ–¥—É–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <script src="settings-panel.js"></script>
</body>
</html>
