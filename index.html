<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --card: #1a1a25;
      --accent: #b388eb;
      --text: #fff;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .controls {
      display: flex;
      gap: 12px;
    }
    .btn {
      background: var(--accent);
      border: 0;
      border-radius: 8px;
      padding: 10px 20px;
      color: var(--bg);
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.25s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn:hover {
      opacity: 0.8;
    }
    .btn.reset {
      background: #ff4757;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: fixed;
    }
    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
      position: relative;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      background: #121218;
      color: var(--accent);
      cursor: col-resize;
      user-select: none;
    }
    th::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 3px;
      height: 100%;
      background: var(--accent);
      opacity: 0.3;
      cursor: col-resize;
    }
    th:hover::after {
      opacity: 0.8;
    }
    tr:hover {
      background: #1f1f2a;
    }
    .action-btn {
      background: var(--accent);
      border: 0;
      border-radius: 50%; /* –°–¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫—Ä—É–≥–ª—ã–º–∏ */
      width: 30px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
      height: 30px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
      padding: 0; /* –£–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
      color: var(--bg);
      font-size: 14px; /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –∏–∫–æ–Ω–∫–∏ */
      cursor: pointer;
      transition: 0.25s;
      display: inline-flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
      align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
      justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
      margin: 2px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
    }
    .action-btn:hover {
      opacity: 0.8;
    }
    .comment-input {
      background: var(--card);
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 10px;
      color: var(--text);
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    .comment-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .loading {
      pointer-events: none;
      opacity: 0.7;
    }
    .success-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .error-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff4757;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .header-controls h1 {
      margin: 0;
      font-size: 1.8em;
      white-space: nowrap;
    }
    .controls {
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    td {
      white-space: nowrap;
    }
    .drag-over {
      border-top: 2px solid var(--accent) !important;
    }
    .dragging {
      opacity: 0.5;
      background-color: #1f1f2a;
    }
    .column-header.drag-over-left {
      border-left: 2px solid var(--accent) !important;
    }
    .column-header.drag-over-right {
      border-right: 2px solid var(--accent) !important;
    }
    .reorder-info {
      font-size: 0.8em;
      color: #888;
      margin-top: 5px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-controls">
      <h1>üìä –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>
      <div class="controls">
        <button class="btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <button class="btn reset" id="resetAllSheetsBtn"><i class="fas fa-trash-alt"></i> –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
      </div>
    </div>
    <p class="reorder-info">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤. –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ.</p>
    <table id="sitesTable">
      <thead>
        <tr id="tableHeaderRow">
          <!-- Headers will be populated by JS -->
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Rows will be populated by JS -->
      </tbody>
    </table>
  </div>

  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
    const API_KEY = 'AIzaSyDpZhPrGTvEnWfpe32sOWs37UlApmwcclI';
    const SPREADSHEET_ID = '10W4LpgK3NGElOv0O1nnTw92cyCeBMAtnFX0dDMOEAjU';
    const DATA_RANGE = 'data!A:F';
    const COMMENTS_RANGE = 'comments!A:B';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQoTQPStRV0ZUr5s3EFAtvgC62jbVjH2cp8VLrMPKBi3vDkoAmafVb_fC4L-jw0LBZ/exec';

    // ===== –ö–õ–Æ–ß–ò –î–õ–Ø LOCAL STORAGE =====
    const COLUMN_ORDER_KEY = 'statsPanelColumnOrder';
    const ROW_ORDER_KEY = 'statsPanelRowOrder';

    // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
    let rawData = [];
    let comments = {};
    let isResizing = false;
    let currentColumn = null;
    let startX = 0;
    let startWidth = 0;
    let tableData = [];
    // –û–±–Ω–æ–≤–ª—è–µ–º columnOrder –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ 'actions' (–∫—É–¥–∞ –¥–æ–±–∞–≤–∏–º –∏ —à–µ—Å—Ç–µ—Ä—ë–Ω–∫—É)
    let columnOrder = ['site', 'visits', 'clicks', 'comment', 'actions'];
    let rowOrder = [];

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    async function init() {
      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('resetAllSheetsBtn').addEventListener('click', resetAllStatsInSheets);
      loadSavedOrder();
      await loadData();
    }

    // ===== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• =====
    async function loadData() {
      document.body.classList.add('loading');
      // –£–ë–†–ê–ù–û: showMessage('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'warning');
      loadSavedOrder();

      try {
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_RANGE}?key=${API_KEY}`;
        const dataRes = await fetch(dataUrl);
        const data = await dataRes.json();
        if (!data.values || data.values.length < 2) {
          showError('–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
          return;
        }
        rawData = data.values.slice(1);

        const commentsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${COMMENTS_RANGE}?key=${API_KEY}`;
        const commentsRes = await fetch(commentsUrl);
        const commentsData = await commentsRes.json();
        comments = {};
        if (commentsData.values && commentsData.values.length > 1) {
          for (let i = 1; i < commentsData.values.length; i++) {
            const [site, comment] = commentsData.values[i];
            if (site) comments[site] = comment || '';
          }
        }

        await processTableData();
        renderTable();
        initDragAndDrop(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

      } catch (err) {
        console.error(err);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + err.message);
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–û–†–Ø–î–ö–ê =====
    function saveColumnOrder() {
      debounce('saveColumnOrder', () => {
        try {
          localStorage.setItem(COLUMN_ORDER_KEY, JSON.stringify(columnOrder));
        } catch (e) {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ localStorage", e);
        }
      }, 500);
    }

    function saveRowOrder() {
      debounce('saveRowOrder', () => {
        try {
          localStorage.setItem(ROW_ORDER_KEY, JSON.stringify(rowOrder));
        } catch (e) {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ –≤ localStorage", e);
        }
      }, 500);
    }

    function loadSavedOrder() {
      try {
        const savedColumnOrder = localStorage.getItem(COLUMN_ORDER_KEY);
        if (savedColumnOrder) {
          columnOrder = JSON.parse(savedColumnOrder);
        }
      } catch (e) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ –∏–∑ localStorage", e);
        // columnOrder –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      }
      try {
        const savedRowOrder = localStorage.getItem(ROW_ORDER_KEY);
        if (savedRowOrder) {
          rowOrder = JSON.parse(savedRowOrder);
        }
      } catch (e) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ –∏–∑ localStorage", e);
        rowOrder = [];
      }
    }

    // ===== –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø –¢–ê–ë–õ–ò–¶–´ =====
    async function processTableData(selectedDate = new Date().toISOString().split('T')[0]) {
      const stats = {};
      const allSites = [...new Set(rawData.map(row => row[0]))];

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      allSites.forEach(site => {
        if (!stats[site]) {
          stats[site] = { visits: 0, clicks: 0, hasData: false };
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö: [site, visits, clicks, timestamp, dateOnly]
      for (let i = 0; i < rawData.length; i++) {
        const [site, v, c, , dateOnly] = rawData[i];
        const rowDate = dateOnly;
        if (selectedDate && rowDate !== selectedDate) continue;
        if (stats[site]) {
          stats[site].visits += parseInt(v) || 0;
          stats[site].clicks += parseInt(c) || 0;
          stats[site].hasData = true;
        }
      }

      // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
      tableData = Object.entries(stats).map(([site, d]) => ({
        site: site,
        visits: d.visits,
        clicks: d.clicks,
        comment: comments[site] || '',
        hasData: d.hasData
      }));

      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç—Ä–æ–∫
      if (rowOrder.length > 0) {
        tableData.sort((a, b) => {
          const indexA = rowOrder.indexOf(a.site);
          const indexB = rowOrder.indexOf(b.site);
          if (indexA !== -1 && indexB !== -1) return indexA - indexB;
          if (indexA !== -1) return -1;
          if (indexB !== -1) return 1;
          return 0;
        });
      }
    }

    // ===== –†–ï–ù–î–ï–†–ò–ù–ì –¢–ê–ë–õ–ò–¶–´ =====
    function renderTableHeader() {
      const theadRow = document.getElementById('tableHeaderRow');
      theadRow.innerHTML = '';
      for (let i = 0; i < columnOrder.length; i++) {
        const colId = columnOrder[i];
        const th = document.createElement('th');
        th.className = 'column-header';
        th.draggable = true;
        th.dataset.columnId = colId;
        switch (colId) {
          case 'site': th.textContent = '–°–∞–π—Ç'; th.style.width = '200px'; break;
          case 'visits': th.textContent = '–í–∏–∑–∏—Ç—ã'; th.style.width = '100px'; break;
          case 'clicks': th.textContent = '–ö–ª–∏–∫–∏ WhatsApp'; th.style.width = '120px'; break;
          case 'comment': th.textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'; th.style.width = '250px'; break;
          case 'actions': th.textContent = '–î–µ–π—Å—Ç–≤–∏—è'; th.style.width = '120px'; break; // –®–∏—Ä–∏–Ω–∞ –¥–ª—è –¥–≤—É—Ö –∫–Ω–æ–ø–æ–∫
          default: th.textContent = colId;
        }
        theadRow.appendChild(th);
      }
    }

    function renderTableBody() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      for (let i = 0; i < tableData.length; i++) {
        const item = tableData[i];
        const tr = document.createElement('tr');
        tr.draggable = true;
        tr.dataset.site = item.site;

        for (let j = 0; j < columnOrder.length; j++) {
          const colId = columnOrder[j];
          const td = document.createElement('td');
          switch (colId) {
            case 'site':
              td.textContent = item.site;
              break;
            case 'visits':
              td.textContent = item.visits;
              break;
            case 'clicks':
              td.textContent = item.clicks;
              break;
            case 'comment':
              const input = document.createElement('input');
              input.type = 'text';
              input.className = 'comment-input';
              input.value = item.comment || '';
              input.dataset.site = item.site;
              input.addEventListener('input', debounce((e) => {
                saveComment(e.target.dataset.site, e.target.value);
              }, 500));
              td.appendChild(input);
              break;
            case 'actions':
              // –ò–∑–º–µ–Ω—è–µ–º —ç—Ç–æ—Ç –±–ª–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–≤—É—Ö –∫–Ω–æ–ø–æ–∫
              const eraseBtn = document.createElement('button');
              eraseBtn.className = 'action-btn';
              eraseBtn.title = '–°–±—Ä–æ—Å–∏—Ç—å';
              eraseBtn.innerHTML = '<i class="fas fa-eraser"></i>';
              eraseBtn.onclick = () => resetSiteStats(item.site);

              const gearBtn = document.createElement('button');
              gearBtn.className = 'action-btn';
              gearBtn.title = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏';
              gearBtn.innerHTML = '‚öôÔ∏è';
              gearBtn.onclick = () => openSettingsModal(item.site); // openSettingsModal –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑ settings-panel.js

              td.appendChild(eraseBtn);
              td.appendChild(gearBtn);
              break;
            default:
              td.textContent = item[colId] || '';
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function renderTable() {
      renderTableHeader();
      renderTableBody();
    }

    // ===== –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï –°–¢–†–û–ö –ò –°–¢–û–õ–ë–¶–û–í =====
    function initDragAndDrop() {
      // ===== –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï –°–¢–†–û–ö =====
      const tbody = document.getElementById('tableBody');
      let draggedRow = null;

      tbody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('dragstart', (e) => {
          draggedRow = row;
          row.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        row.addEventListener('dragend', (e) => {
          row.classList.remove('dragging');
          tbody.querySelectorAll('tr').forEach(r => r.classList.remove('drag-over'));
          draggedRow = null;
        });

        row.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        row.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (row !== draggedRow) {
            row.classList.add('drag-over');
          }
        });

        row.addEventListener('dragleave', (e) => {
          row.classList.remove('drag-over');
        });

        row.addEventListener('drop', (e) => {
          e.preventDefault();
          row.classList.remove('drag-over');
          if (draggedRow && draggedRow !== row) {
            const rect = row.getBoundingClientRect();
            const nextSibling = (e.clientY - rect.top) / (rect.bottom - rect.top) < 0.5 ? row : row.nextSibling;
            tbody.insertBefore(draggedRow, nextSibling);
            updateRowOrderFromDOM();
            saveRowOrder();
          }
        });
      });

      // ===== –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï –ó–ê–ì–û–õ–û–í–ö–û–í –°–¢–û–õ–ë–¶–û–í =====
      const headers = document.querySelectorAll('.column-header');
      let draggedHeader = null;

      for (let i = 0; i < headers.length; i++) {
        const header = headers[i];
        if (!header.style.width) {
          header.style.width = header.offsetWidth + 'px';
        }

        header.addEventListener('dragstart', (e) => {
          draggedHeader = header;
          header.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        header.addEventListener('dragend', (e) => {
          header.classList.remove('dragging');
          document.querySelectorAll('.column-header').forEach(h => h.classList.remove('drag-over-left', 'drag-over-right'));
          draggedHeader = null;
        });

        header.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        header.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (header !== draggedHeader) {
            const rect = header.getBoundingClientRect();
            if (e.clientX - rect.left < rect.width / 2) {
              header.classList.add('drag-over-left');
            } else {
              header.classList.add('drag-over-right');
            }
          }
        });

        header.addEventListener('dragleave', (e) => {
          header.classList.remove('drag-over-left', 'drag-over-right');
        });

        header.addEventListener('drop', (e) => {
          e.preventDefault();
          header.classList.remove('drag-over-left', 'drag-over-right');
          if (draggedHeader && draggedHeader !== header) {
            const oldIndex = columnOrder.indexOf(draggedHeader.dataset.columnId);
            const newIndex = columnOrder.indexOf(header.dataset.columnId);
            if (oldIndex !== -1 && newIndex !== -1) {
              const movedItem = columnOrder.splice(oldIndex, 1)[0];
              const insertIndex = e.clientX < header.getBoundingClientRect().left + header.offsetWidth / 2 ? newIndex : newIndex + 1;
              const finalIndex = oldIndex < insertIndex ? insertIndex - 1 : insertIndex;
              columnOrder.splice(finalIndex, 0, movedItem);
              renderTable();
              saveColumnOrder();
            }
          }
        });

        header.addEventListener('mousedown', (e) => {
          if (e.offsetX > header.offsetWidth - 10) {
            isResizing = true;
            currentColumn = header;
            startX = e.pageX;
            startWidth = header.offsetWidth;
            document.body.style.cursor = 'col-resize';
            document.body.classList.add('resizing');
            e.preventDefault();
          }
        });
      }
    }

    function updateRowOrderFromDOM() {
      const tbody = document.getElementById('tableBody');
      rowOrder = Array.from(tbody.children).map(row => row.dataset.site);
    }

    // ===== –î–ï–ë–ê–£–ù–° =====
    let debounceTimers = {};
    function debounce(id, func, delay) {
      if (debounceTimers[id]) {
        clearTimeout(debounceTimers[id]);
      }
      debounceTimers[id] = setTimeout(func, delay);
    }

    // ===== –°–ë–†–û–° –°–¢–ê–¢–ò–°–¢–ò–ö–ò –°–ê–ô–¢–ê =====
    async function resetSiteStats(site) {
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è —Å–∞–π—Ç–∞ ${site}?`)) return;
      document.body.classList.add('loading');
      // –£–ë–†–ê–ù–û: showMessage(`–°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è ${site}...`, 'warning');
      const form = new URLSearchParams();
      form.append('action', 'resetSiteStats');
      form.append('site', site);
      try {
        const res = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const txt = await res.text();
        let data;
        try {
          data = JSON.parse(txt);
        } catch (e) {
          console.error("Raw response:", txt);
          throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
        }
        if (data.status !== 'success') throw new Error(data.message);
        // –£–ë–†–ê–ù–û: showMessage(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è ${site} —Å–±—Ä–æ—à–µ–Ω–∞!`);
        await loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      } catch (err) {
        console.error(err);
        // –£–ë–†–ê–ù–û: showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è ${site}: ${err.message}`, 'warning');
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø =====
    async function saveComment(site, comment) {
      const form = new URLSearchParams();
      form.append('action', 'saveComment');
      form.append('site', site);
      form.append('comment', comment);
      try {
        const res = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const txt = await res.text();
        let data;
        try {
          data = JSON.parse(txt);
        } catch (e) {
          console.error("Raw response:", txt);
          throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
        }
        if (data.status !== 'success') throw new Error(data.message);
        // –£–ë–†–ê–ù–û: showMessage('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
      } catch (err) {
        console.error(err);
        // –£–ë–†–ê–ù–û: showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + err.message, 'warning');
      }
    }

    // ===== –°–ë–†–û–° –í–°–ï–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò –í –¢–ê–ë–õ–ò–¶–ï =====
    async function resetAllStatsInSheets() {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –í–°–ï–• —Å–∞–π—Ç–æ–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
      try {
        document.body.classList.add('loading');
        // –£–ë–†–ê–ù–û: showMessage('–°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ...', 'warning');
        const form = new URLSearchParams();
        form.append('action', 'resetAllStats');
        const res = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: form
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const txt = await res.text();
        let data;
        try {
          data = JSON.parse(txt);
        } catch (e) {
          console.error("Raw response:", txt);
          throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
        }
        if (data.status !== 'success') throw new Error(data.message);
        // –£–ë–†–ê–ù–û: showMessage('–í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞!');
        await loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      } catch (error) {
        console.error(error);
        // –£–ë–†–ê–ù–û: showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'warning');
      } finally {
        document.body.classList.remove('loading');
      }
    }

    // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    // function showMessage(message, type = 'success') { // –£–¥–∞–ª–µ–Ω–æ
    //   hideMessage();
    //   const messageDiv = document.createElement('div');
    //   messageDiv.className = type === 'success' ? 'success-message' : 'success-message'; // –ò–∑–º–µ–Ω–µ–Ω–æ: –≤—Å–µ–≥–¥–∞ success-message
    //   messageDiv.textContent = message;
    //   messageDiv.id = 'tempMessage';
    //   document.body.appendChild(messageDiv);
    //   setTimeout(hideMessage, 3000);
    // }

    function showError(message) {
      // –£–ë–†–ê–ù–û: showMessage(message, 'error');
      console.error(message);
      alert(message); // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    }

    // function hideMessage() { // –£–¥–∞–ª–µ–Ω–æ
    //   const existingMessage = document.getElementById('tempMessage');
    //   if (existingMessage) existingMessage.remove();
    // }

    // ===== –ò–ó–ú–ï–ù–ï–ù–ò–ï –†–ê–ó–ú–ï–†–ê –ö–û–õ–û–ù–û–ö =====
    document.addEventListener('mousemove', (e) => {
      if (isResizing && currentColumn) {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth > 50) {
          currentColumn.style.width = newWidth + 'px';
          const columnIndex = Array.from(currentColumn.parentNode.children).indexOf(currentColumn);
          const rows = document.querySelectorAll('#sitesTable tr');
          for (let i = 0; i < rows.length; i++) {
            const cell = rows[i].children[columnIndex];
            if (cell) cell.style.width = newWidth + 'px';
          }
        }
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.classList.remove('resizing');
        currentColumn = null;
      }
    });

    // ===== –ó–ê–ü–£–°–ö =====
    document.addEventListener('DOMContentLoaded', init);

  </script>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å settings-panel.js -->
  <script src="settings-panel.js"></script>
  </body>
</html>



